<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Zeitauswertung</title>

  <link rel="stylesheet" href="stylesauswertung.css">
  <link rel="manifest" href="/manifest.json">

  <!-- jsPDF mit Fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"
          onerror="(function(){var s=document.createElement('script');s.src='/vendor/jspdf.umd.min.js';document.head.appendChild(s)})();"></script>
  <script>
    (function(){
      const CDN1  = "https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js";
      const CDN2  = "https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js";
      const LOCAL = "/vendor/jspdf.umd.min.js";
      function load(src){
        return new Promise((res, rej)=>{
          if ([...document.scripts].some(s => s.src === src)) return res();
          const s = document.createElement("script");
          s.src = src; s.async = true; s.crossOrigin="anonymous"; s.referrerPolicy="no-referrer";
          s.onload = res; s.onerror = ()=>rej(new Error("load fail: "+src));
          document.head.appendChild(s);
        });
      }
      window.getJsPDF = function(){
        if (window.__jspdfPromise) return window.__jspdfPromise;
        window.__jspdfPromise = (async()=>{
          if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
          try { await load(CDN1); } catch { try { await load(CDN2); } catch { await load(LOCAL); } }
          if (!window.jspdf?.jsPDF) throw new Error("jsPDF nicht verfügbar");
          return window.jspdf.jsPDF;
        })();
        return window.__jspdfPromise;
      };
    })();
  </script>

  <style>
    .btn-action{
      display:block; width:80%; max-width:320px; margin:14px auto;
      padding:18px 28px; font-size:1.2em; font-weight:700; border-radius:40px;
      cursor:pointer; border:none; text-align:center; text-decoration:none; color:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,0.25); transition:transform .15s, box-shadow .2s;
    }
    .btn-action:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.35); }
    .btn-action:active{ transform: scale(.97); }
    .btn-blue{ background:#2002e0; }
    .btn-red { background:#e53935; }
  </style>
</head>

<body>
  <h1>Zeitauswertung</h1>

  <h2>Gesamtzeit:</h2>
  <div id="gesamtzeit">Wird geladen...</div>

  <h2>Patientenzeiten:</h2>
  <table>
    <thead>
      <tr><th>Patientenseite</th><th>Zeit (MM:SS)</th></tr>
    </thead>
    <tbody id="patientenzeiten"></tbody>
  </table>

  <h2>Sichtungskategorien:</h2>
  <table>
    <thead>
      <tr><th>Patientenseite</th><th>Sichtung</th></tr>
    </thead>
    <tbody id="patientenfarben"></tbody>
  </table>

  <div class="actions">
    <button id="downloadPDF" class="btn-action btn-blue">Auswertung als PDF</button>
    <a id="toAblage" href="/ablage1.html" class="btn-action btn-blue">Zur Patientenablage</a>
    <button id="neuerEinsatzButton" class="btn-action btn-red">Neuer Einsatz</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ---------- Helpers ----------
    const mmss = (sec)=>`${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;

    const pageLabelFromKey = (key, prefix) => {
      let p = key.startsWith(prefix) ? key.slice(prefix.length) : key;
      try { p = p.split('/').pop() || p; } catch {}
      if ((p||'').toLowerCase().includes('index.html')) return 'Anfahrt Einsatzstelle';
      const m = (p||'').match(/patient(\d+)\.html/i);
      return m ? `Patient ${m[1]}` : p;
    };

    // patient15, patient15.html, /patient15.html, Patient 15 → patient15
    function normalizePatientId(key){
      const s = String(key || '').trim().toLowerCase();
      const m1 = s.match(/patient\s*0*(\d+)/i);
      if (m1) return 'patient' + String(parseInt(m1[1], 10));
      const m2 = s.match(/patient[_\- ]*0*(\d+)/i);
      if (m2) return 'patient' + String(parseInt(m2[1], 10));
      return null;
    }

    // Map in ein sauberes patientXX -> value überführen
    function getSMap(){
      let raw = {};
      try{ raw = JSON.parse(localStorage.getItem('sichtungMap')||'{}'); }catch{ raw = {}; }
      const out = {};
      for (const [k,v] of Object.entries(raw)){
        const id = normalizePatientId(k);
        if(!id) continue;
        out[id] = v;
      }
      return out;
    }

    const normKat = (v)=>{
      v = String(v||'').trim().toLowerCase();
      if (v.includes('grün')) v = v.replace('grün','gruen');
      // SK1/SK2/... zulassen
      if (v === 'sk1') return 'rot';
      if (v === 'sk2') return 'gelb';
      if (v === 'sk3') return 'gruen';
      if (v === 'sk4') return 'schwarz';
      return v;
    };

    function __readTogglePayload(id){
      let raw=null;
      try { raw = localStorage.getItem("sicht_" + id); } catch {}
      if (!raw) {
        const pathKey = "sicht_" + (location.pathname.split("/").pop() || "unknown");
        try { raw = localStorage.getItem(pathKey); } catch {}
      }
      if (!raw) return {};
      try { return JSON.parse(raw)||{}; } catch { return {}; }
    }

    function getSichtungDisplay(id, cat){
      const p = __readTogglePayload(id);
      if (cat === 'rot')      return 'SK1' + (p.t ? ' · T' : '');
      if (cat === 'gelb')     return 'SK2';
      if (cat === 'gruen')    return 'SK3' + (p.b ? ' · B' : '');
      if (cat === 'schwarz')  return 'SK4';
      return '';
    }

    function __prio(cat, flags){
      const t=!!flags?.t, b=!!flags?.b;
      if (cat==='rot'   && t) return 0; // SK1 · T
      if (cat==='rot')        return 1; // SK1
      if (cat==='gelb')       return 2; // SK2
      if (cat==='gruen' && b) return 3; // SK3 · B
      if (cat==='gruen')      return 4; // SK3
      if (cat==='schwarz')    return 5; // SK4
      return 6;
    }
    function __numFromId(id){ return parseInt(String(id).replace(/\D/g,''))||99999; }

    // ---------- Gesamt- / Patientenzeiten ----------
    function collectTimes() {
      const rows = []; let total = 0;
      Object.keys(localStorage).forEach(k=>{
        if (!k.startsWith('time_')) return;
        const sec = parseInt(localStorage.getItem(k))||0; total += sec;
        rows.push({ page: pageLabelFromKey(k,'time_'), sec, mm: mmss(sec) });
      });
      rows.sort((a,b)=>{
        const ak = a.page.startsWith('Anfahrt') ? 0 : (parseInt(a.page.replace(/\D/g,''))||9999);
        const bk = b.page.startsWith('Anfahrt') ? 0 : (parseInt(b.page.replace(/\D/g,''))||9999);
        return ak - bk;
      });
      return { rows, total };
    }

    const { rows: timeRows, total } = collectTimes();
    document.getElementById('gesamtzeit').textContent = mmss(total);
    const tBodyTimes = document.getElementById('patientenzeiten');
    tBodyTimes.innerHTML = '';
    timeRows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.page}</td><td>${r.mm}</td>`;
      tBodyTimes.appendChild(tr);
    });

    // ---------- Sichtungen (Anzeige + Sortierung nach Prio) ----------
    function readSichtungenDedup() {
      const sMap = getSMap();
      let ablage = [];
      try { ablage = JSON.parse(localStorage.getItem('ablage.active.v1') || '[]'); } catch {}

      const out = new Map(); // id -> { id, sk }
      Object.entries(sMap).forEach(([id, sk])=>{
        if(!id || !sk) return;
        out.set(String(id).toLowerCase(), { id:String(id).toLowerCase(), sk });
      });

      // falls du irgendwann aktiv-einträge mit sk drin hast
      ablage.forEach(r=>{
        const id = normalizePatientId(r?.id || '') || String(r?.id||'').toLowerCase();
        const sk = r?.sk;
        if(!id || !sk) return;
        if(!out.has(id)) out.set(id, { id, sk });
      });

      return [...out.values()];
    }

    function renderSichtungenTable() {
      const tbody = document.getElementById('patientenfarben');
      tbody.innerHTML = '';

      const items = readSichtungenDedup();
      items.sort((a,b)=>{
        const aCat = normKat(a.sk), bCat = normKat(b.sk);
        const ap = __readTogglePayload(a.id), bp = __readTogglePayload(b.id);
        const d  = __prio(aCat, ap) - __prio(bCat, bp);
        return d !== 0 ? d : (__numFromId(a.id) - __numFromId(b.id));
      });

      items.forEach(({id, sk})=>{
        const label = id.replace(/^patient(\d+)/i, 'Patient $1');
        const cat = normKat(sk);

        let bg='white', color='black';
        if (cat==='rot'){ bg='red'; color='white'; }
        else if (cat==='gelb'){ bg='yellow'; color='black'; }
        else if (cat==='gruen'){ bg='green'; color='white'; }
        else if (cat==='schwarz'){ bg='black'; color='white'; }

        const display = getSichtungDisplay(id, cat);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${label}</td>
          <td style="background:${bg};color:${color};font-weight:700;text-align:center">${display}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    renderSichtungenTable();

    // ---------- Reset-Funktionen ----------
    function resetAllData() {
      Object.keys(localStorage).forEach(k=>{
        // Zeiten
        if (k.startsWith('time_')) localStorage.removeItem(k);

        // Sichtungen (Map + alte Varianten)
        if (k === 'sichtungMap') localStorage.removeItem(k);
        if (k.startsWith('sicht_')) localStorage.removeItem(k);       // T/B Payloads pro Patient
        if (k.startsWith('sichtung_')) localStorage.removeItem(k);    // falls du irgendwo noch so Keys nutzt

        // Ablage
        if (k === 'ablage.active.v1') localStorage.removeItem(k);
        if (k === 'ablage.history.v1') localStorage.removeItem(k);
        if (k === 'ablage.done.v1') localStorage.removeItem(k);
        if (k === 'ablage.sessionStart.v1') localStorage.removeItem(k);
        if (k === 'ablage') localStorage.removeItem(k);
        if (k === 'ablage_ids') localStorage.removeItem(k);
      });

      localStorage.setItem('resetFlag', 'true');
    }

    function resetAuswertungData() {
      Object.keys(localStorage).forEach(k=>{
        // NUR Zeiten + Sichtung (damit Ablage danach sauber startet)
        if (k.startsWith('time_')) localStorage.removeItem(k);

        if (k === 'sichtungMap') localStorage.removeItem(k);
        if (k.startsWith('sicht_')) localStorage.removeItem(k);
        if (k.startsWith('sichtung_')) localStorage.removeItem(k);
      });

      localStorage.setItem('resetFlag', 'true');
    }

    // ---------- Buttons ----------
    document.getElementById('neuerEinsatzButton')?.addEventListener('click', ()=>{
      resetAllData();
      window.location.href = "/index.html";
    });

    document.getElementById('toAblage')?.addEventListener('click', (e)=>{
      e.preventDefault();
      // WICHTIG: Sichtungen/Zeiten in Auswertung zurücksetzen (wie bisher gewünscht)
      resetAuswertungData();

      // UI leeren
      document.getElementById('gesamtzeit').textContent = '00:00';
      document.getElementById('patientenzeiten').innerHTML = '';
      document.getElementById('patientenfarben').innerHTML = '';

      window.location.href = "/ablage1.html";
    });

    // ---------- PDF ----------
    document.getElementById('downloadPDF').addEventListener('click', async ()=>{
      const btn = document.getElementById('downloadPDF');
      if (btn.dataset.busy === '1') return;
      btn.dataset.busy = '1'; btn.disabled = true;

      try {
        const jsPDF = await getJsPDF();
        const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
        const margin = 14, pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
        let y = margin;

        function ensure(h){ if (y + h > pageH - margin) { doc.addPage(); y = margin; } }
        function header(t){
          doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(t, margin, y);
          const d = new Date().toLocaleString('de-DE',{dateStyle:'medium', timeStyle:'short'});
          doc.setFont('helvetica','normal'); doc.setFontSize(10);
          doc.text(`Erstellt: ${d}`, margin, y+6); y += 14;
        }

        header('Zeitauswertung – 1Rettungsmittel');

        // Zeiten
        (function(){
          const { rows: timeRows2, total: total2 } = collectTimes();

          ensure(12);
          doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Gesamtzeit', margin, y); y += 8;
          doc.setFont('helvetica','normal'); doc.setFontSize(12); doc.text(mmss(total2), margin, y); y += 10;

          doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Patientenzeiten', margin, y); y += 8;
          doc.setFont('helvetica','bold'); doc.setFontSize(11);
          doc.text('Position', margin, y);
          doc.text('Zeit (MM:SS)', pageW - margin, y, {align:'right'});
          y += 4; doc.setDrawColor(180); doc.line(margin, y, pageW - margin, y); y += 3;

          timeRows2.forEach(r=>{
            doc.setFont('helvetica','normal'); doc.setFontSize(10);
            ensure(7);
            doc.text(String(r.page), margin, y);
            doc.text(String(r.mm), pageW - margin, y, {align:'right'});
            y += 6;
          });
        })();

        // Sichtungen
        (function(){
          ensure(12);
          doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Sichtungskategorien', margin, y); y += 8;

          const rows = (function(){
            const items = readSichtungenDedup();
            return items.map(x => ({ id:x.id, sk:x.sk }));
          })();

          rows.sort((a,b)=>{
            const aCat = normKat(a.sk), bCat = normKat(b.sk);
            const ap = __readTogglePayload(a.id), bp = __readTogglePayload(b.id);
            const d  = __prio(aCat, ap) - __prio(bCat, bp);
            return d !== 0 ? d : (__numFromId(a.id) - __numFromId(b.id));
          });

          rows.forEach(r=>{
            ensure(8);
            const cat = normKat(r.sk);
            const disp = getSichtungDisplay(r.id, cat);
            const name = r.id.replace(/^patient(\d+)/i, 'Patient $1');

            const palette = {
              'rot':     { fill:[220,38,38], text:[255,255,255] },
              'gelb':    { fill:[234,179,8], text:[0,0,0]       },
              'gruen':   { fill:[22,163,74], text:[255,255,255] },
              'schwarz': { fill:[0,0,0],     text:[255,255,255] },
              '':        { fill:[229,231,235], text:[0,0,0]     }
            };
            const meta = palette[cat] || palette[''];

            doc.setFont('helvetica','normal'); doc.setFontSize(10);
            doc.text(name, margin, y);

            const badgeW = 40, badgeH = 6, badgeX = pageW - margin - badgeW, badgeY = y - 4;
            doc.setFillColor(...meta.fill);
            doc.roundedRect(badgeX, badgeY, badgeW, badgeH, 1, 1, 'F');
            doc.setTextColor(...meta.text);
            doc.setFont('helvetica','bold'); doc.setFontSize(10);
            doc.text(disp || '—', badgeX + 2, y);
            doc.setTextColor(0,0,0);

            y += 7;
          });
        })();

        doc.save('auswertung.pdf');
      } catch (err) {
        alert('PDF kann nicht erstellt werden.');
        console.error(err);
      } finally {
        btn.disabled = false; btn.dataset.busy='0';
      }
    });
  });
  </script>

  <!-- optional: coop/freigabe/warmup/metrics wie bei dir -->
  <script src="/coop.js"></script>
  <script type="module" src="/freigabe.js?cache=9"></script>
  <script defer src="/warmup.js?v=2025-08-22-1"></script>
  <script src="/metrics.js" defer></script>
</body>
</html>
