<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <title>1 Rettungsmittel V.1.0</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/LogoApp.jpg" type="image/jpeg" />

  <!-- jsQR lokal , nicht render blockierend -->
  <script src="/vendor/jsqr.min.js" defer></script>

  <!-- Szenarien zentral -->
  <script src="/szenarien.js?v=1" defer></script>

  <!-- Lizenz , Install Logik -->
  <script src="/freigabe.js?v=2025-11-22-RETRY" defer></script>

  <style>
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
      margin:0;
      padding:0;
    }

    html{
      min-height:100%;
      background-image:url(fotos/Leit1.jpg);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-color:#000;
    }

    html::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.52);
      z-index:-1;
      pointer-events:none;
    }

    body{
      font-family: Arial, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      position:relative;
    }

    /* Start Gate Overlay */
    #startGate{
      position:fixed;
      inset:0;
      z-index:100000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      background:rgba(0,0,0,.72);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-sizing:border-box;
    }
    #startGate .gateCard{
      width:min(560px,92vw);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.22);
      border-radius:18px;
      padding:16px;
      box-shadow:0 14px 34px rgba(0,0,0,.34);
      color:#fff;
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      box-sizing:border-box;
    }
    #startGate .gateTitle{
      font-weight:950;
      font-size:17px;
    }
    #startGate .gateText{
      margin-top:10px;
      opacity:.92;
      font-weight:650;
      line-height:1.35;
    }
    #startGate .gateHint{
      margin-top:10px;
      opacity:.75;
      font-size:12px;
      font-weight:650;
    }
    #btnStartGate{
      margin-top:14px;
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:none;
      background:#0B5FFF;
      color:#fff;
      font-weight:950;
      cursor:pointer;
      touch-action:manipulation;
    }
    #btnStartGate:active{ transform:scale(.99); }

    /* Top Buttons */
    .top-button-container{
      position:fixed;
      top:10px; left:10px; right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      z-index:1001;
      box-sizing:border-box;
    }
    @supports (padding: max(0px)) {
      .top-button-container{
        top: max(10px, env(safe-area-inset-top));
        left: max(10px, env(safe-area-inset-left));
        right: max(10px, env(safe-area-inset-right));
      }
    }

    .btn{
      padding:14px 20px;
      font-size:1.05em;
      font-weight:800;
      color:#fff;
      text-decoration:none;
      border-radius:14px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 14px 30px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.25),
        inset 0 -1px 0 rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      transform:translateY(-2px);
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 20px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.28),
        inset 0 -1px 0 rgba(0,0,0,.28);
    }
    .btn:active{
      transform:translateY(0);
      background: rgba(255,255,255,.14);
      box-shadow:
        0 14px 30px rgba(0,0,0,.45),
        inset 0 2px 10px rgba(0,0,0,.22);
    }

    main{
      width:100%;
      max-width:100%;
      margin:0 auto;
      padding-top:90px;
      box-sizing:border-box;
    }

    .image-container, .camera-container{
      width:100%;
      max-width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      box-sizing:border-box;
    }

    /* Status Buttons */
    .status-btn{
      display:block;
      width:clamp(280px, 92vw, 520px);
      padding:32px 44px;
      margin:18px auto;
      font-size:clamp(1.35rem, 4.6vw, 1.85rem);
      font-weight:900;
      line-height:1.12;
      letter-spacing:.2px;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      border:none;
      border-radius:22px;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    .status-btn::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,0,40,.28), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(255,0,40,.14), transparent 60%);
      pointer-events:none;
      opacity:.55;
    }
    .status-btn--primary{
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.28);
    }
    .status-btn--primary::before{ opacity:.75; }
    .status-btn:hover{
      transform:translateY(-3px);
      background: rgba(0,0,0,.24);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 28px 60px rgba(0,0,0,.60),
        inset 0 1px 0 rgba(255,255,255,.18);
    }
    .status-btn:active{
      transform:translateY(0);
      background: rgba(0,0,0,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 2px 12px rgba(0,0,0,.30);
    }

    /* Ripple */
    .status-btn .ripple{
      position:absolute;
      border-radius:50%;
      background:rgba(255,255,255,.40);
      transform:scale(0);
      animation:ripple .6s linear;
      pointer-events:none;
    }
    @keyframes ripple{ to{ transform:scale(4); opacity:0; } }

    /* Melder Overlay */
    .melder-overlay{
      position:fixed;
      inset:0;
      z-index:9998;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 18px;
      box-sizing:border-box;
      transition: opacity .40s ease;
      opacity: 0;
    }
    .melder-overlay.open{
      display:flex;
      opacity: 1;
    }

    .melder-wrap{
      width: min(92vw, 560px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 16px;
    }

    .melderCard{
      position:relative;
      width: 100%;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 24px 70px rgba(0,0,0,.65);
      transform: translateY(0);
      opacity: 1;
    }
    .melderCard.is-hidden{
      transform: translateY(10px);
      opacity: 0;
    }

    .melderImg{
      width:100%;
      height:auto;
      display:block;
      border-radius: 18px;
    }

    .display{
      position:absolute;
      left: 18.0%;
      top: 28.3%;
      width: 64.8%;
      height: 38.6%;
      border-radius: 10px;
      overflow:hidden;
      background: radial-gradient(circle at 30% 30%, rgba(210,255,120,.95), rgba(170,220,70,.90));
      box-shadow:
        0 0 0 1px rgba(0,0,0,.18),
        0 10px 20px rgba(0,0,0,.25),
        0 0 28px rgba(180,255,120,.35);
      filter: saturate(1.05) contrast(1.06);
    }
    .display::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 12px rgba(0,0,0,.22);
    }

    .lines{
      position:absolute;
      inset: 10% 6% 10% 6%;
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-weight: 900;
      color:#000;
      font-size: clamp(12px, 2.8vw, 16px);
      line-height: 1.15;
      text-align:left;
    }
    .line{
      white-space: normal;
      word-break: break-word;
      min-height: 1em;
    }

    .melderConfirm{
      width: min(92vw, 520px);
      padding: 20px 18px;
      border-radius: 22px;
      color:#fff;
      font-weight: 900;
      font-size: clamp(18px, 4.6vw, 22px);
      letter-spacing: .2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .melderConfirm:hover{
      transform: translateY(-2px);
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 28px 60px rgba(0,0,0,.60),
        inset 0 1px 0 rgba(255,255,255,.18);
    }
    .melderConfirm:active{
      transform: translateY(0);
      background: rgba(0,0,0,.20);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 2px 12px rgba(0,0,0,.30);
    }
    .melderConfirm:disabled{
      opacity:.55;
      cursor: default;
      transform:none;
    }

    .melderReopen{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 1002;
      display:none;
      padding: 14px 16px;
      border-radius: 16px;
      color:#fff;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 14px 30px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.25),
        inset 0 -1px 0 rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .melderReopen:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.30);
    }
    .melderReopen:active{
      transform: translateY(0);
    }

    @keyframes pagerEnter {
      0%   { transform: translateY(22px) scale(.985); opacity: 0; filter: blur(2px); }
      60%  { transform: translateY(-2px) scale(1.0);  opacity: 1; filter: blur(0); }
      100% { transform: translateY(0) scale(1.0); }
    }

    @keyframes pagerShake {
      0%   { transform: translate(0,0) rotate(0deg); }
      10%  { transform: translate(-2px, 2px) rotate(-.2deg); }
      20%  { transform: translate(3px, -2px) rotate(.2deg); }
      30%  { transform: translate(-3px, 1px) rotate(-.25deg); }
      40%  { transform: translate(3px, 2px) rotate(.25deg); }
      50%  { transform: translate(-2px, -2px) rotate(-.15deg); }
      60%  { transform: translate(2px, 1px) rotate(.15deg); }
      70%  { transform: translate(-1px, 1px) rotate(-.1deg); }
      80%  { transform: translate(1px, -1px) rotate(.1deg); }
      90%  { transform: translate(-1px, 0) rotate(-.05deg); }
      100% { transform: translate(0,0) rotate(0deg); }
    }

    @keyframes lcdPulse {
      0%   { filter: brightness(1.00) saturate(1.02) contrast(1.05); }
      20%  { filter: brightness(1.14) saturate(1.10) contrast(1.07); }
      45%  { filter: brightness(0.98) saturate(1.00) contrast(1.06); }
      70%  { filter: brightness(1.10) saturate(1.08) contrast(1.07); }
      100% { filter: brightness(1.00) saturate(1.02) contrast(1.05); }
    }

    @keyframes lcdFlicker {
      0%   { opacity: 1; }
      6%   { opacity: .92; }
      10%  { opacity: .99; }
      18%  { opacity: .88; }
      22%  { opacity: 1; }
      38%  { opacity: .95; }
      44%  { opacity: .85; }
      48%  { opacity: 1; }
      70%  { opacity: .93; }
      78%  { opacity: .98; }
      100% { opacity: 1; }
    }

    @keyframes pagerExit {
      0%   { transform: translateY(0) scale(1); opacity: 1; filter: blur(0); }
      100% { transform: translateY(34px) scale(.99); opacity: 0; filter: blur(2px); }
    }

    .melderCard.is-entering{ animation: pagerEnter .55s ease-out both; }
    .melderCard.is-alarming{ animation: pagerShake 1.15s ease-in-out infinite; }
    .melderCard.is-exiting { animation: pagerExit .65s ease-in both; }

    .display.is-waking{ animation: lcdPulse 2.2s ease-in-out both; }
    .display.is-flicker::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      mix-blend-mode: overlay;
      opacity:.12;
      animation: lcdFlicker 2.2s linear infinite;
    }

    /* Scanner Overlay */
    .scan-overlay{
      position:fixed; inset:0; z-index:9999;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.85);
    }
    .scan-overlay.open{ display:flex; }
    .scan-ui{ position:relative; width:min(100vw,800px); height:min(100vh,1000px); padding:12px; box-sizing:border-box; }
    #scanVideo{ width:100%; height:100%; object-fit:cover; background:#000; border-radius:10px; }
    .scan-topbar{
      position:absolute; top:10px; right:10px; left:10px;
      display:flex; justify-content:flex-end; gap:8px; pointer-events:none;
    }
    .scan-close{
      pointer-events:auto; font-size:32px; line-height:1; padding:8px 12px;
      border:none; border-radius:12px; color:#fff;
      background:rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
    }
    .scan-close:hover{ background:rgba(255,255,255,.20); border-color: rgba(255,255,255,.30); }
    .scan-frame{
      position:absolute; inset:15% 10%;
      border:3px solid rgba(255,255,255,.7); border-radius:12px; pointer-events:none;
    }
  </style>

  <link rel="stylesheet" href="/app-flow.css">
</head>

<body>

  <div id="startGate" role="dialog" aria-modal="true" aria-label="Hinweis Hochformat und Audio">
    <div class="gateCard">
      <div class="gateTitle">Hinweis</div>
      <div class="gateText">Zur besten Darstellung und Performance bitte das Tablet im Hochformat nutzen.</div>
      <button id="btnStartGate" type="button">Verstanden</button>
      <div class="gateHint">Tippen aktiviert auch die Alarmtöne für diesen Einsatz.</div>
    </div>
  </div>

  <div class="top-button-container">
    <a href="/instruktor.html" class="btn">Instruktor</a>
    <a href="/index.html" class="btn">Startseite</a>
  </div>

  <main>
    <div class="image-container">
      <button id="startButton" class="status-btn">
        Status 1<br>Fahrzeug einsatzbereit
      </button>
    </div>

    <div class="camera-container">
      <button id="cameraButton" class="status-btn status-btn--primary">
        Status 4<br>Fahrzeug Einsatzstelle<br>erreicht
      </button>
    </div>
  </main>

  <div id="melderOverlay" class="melder-overlay" aria-hidden="true">
    <div class="melder-wrap">
      <div class="melderCard is-hidden">
        <img class="melderImg" src="/fotos/Melder_Leer.png" alt="Melder">
        <div class="display">
          <div id="melderLines" class="lines"></div>
        </div>
      </div>
      <button id="melderConfirmBtn" class="melderConfirm" disabled>Status 3</button>
    </div>
  </div>

  <button id="melderReopen" class="melderReopen" type="button" aria-label="Melder erneut öffnen">
     Melder
  </button>

  <div id="scannerOverlay" class="scan-overlay" aria-hidden="true">
    <div class="scan-ui">
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" hidden></canvas>
      <div class="scan-frame"></div>
      <div class="scan-topbar">
        <button id="scanCloseBtn" class="scan-close" aria-label="Scanner schließen">×</button>
      </div>
    </div>
  </div>

  <script>
    const ASSET_VER = '2026-02-02-1';
    const PRE_URL   = `/status1_pre.mp3?v=${ASSET_VER}`;
    const ALARM_URL = `/Alarmton2.mp3?v=${ASSET_VER}`;

    const alarmAudio = new Audio(ALARM_URL);
    alarmAudio.preload = 'auto';

    let __audioPrimed = false;

    function makePreAudio(){
      const a = new Audio(PRE_URL);
      a.preload = 'auto';
      try { a.playsInline = true; } catch {}
      return a;
    }

    function primeAudioEl(a){
      try{
        a.muted = true;
        a.currentTime = 0;
        const p = a.play();
        if (p && p.then){
          p.then(()=>{
            try{ a.pause(); }catch{}
            try{ a.currentTime = 0; }catch{}
            a.muted = false;
          }).catch(()=>{});
        }
      }catch{}
    }

    function primeAllSounds(){
      if (__audioPrimed) return;
      __audioPrimed = true;

      const tmp = makePreAudio();
      primeAudioEl(tmp);

      primeAudioEl(alarmAudio);

      try { alarmAudio.load(); } catch {}
    }

    function playPreSoundThen(nextFn){
      const a = makePreAudio();

      const done = () => {
        try { a.onended = null; a.onerror = null; } catch {}
        try { nextFn && nextFn(); } catch(e){ console.warn(e); }
      };

      try { a.onended = done; a.onerror = done; } catch {}

      try { a.pause(); a.currentTime = 0; } catch {}
      try { a.load(); } catch {}

      a.play().catch(() => done());
    }

    const wait = (ms)=> new Promise(r => setTimeout(r, ms));

    function normalizeSoundUrl(u){
      try{
        if (!u) return ALARM_URL;
        const url = new URL(u, location.origin);
        if (url.origin === location.origin && url.pathname.toLowerCase().endsWith('.mp3')) {
          if (!url.search) url.search = `?v=${ASSET_VER}`;
          return url.pathname + url.search;
        }
        return url.href;
      }catch{
        return ALARM_URL;
      }
    }
  </script>

  <script>
    (function(){
      'use strict';

      const gate = document.getElementById('startGate');
      const btn  = document.getElementById('btnStartGate');

      function hideGate(){
        if (gate) gate.style.display = 'none';
      }

      async function onConfirm(){
        try{
          if (typeof primeAllSounds === 'function') primeAllSounds();
        }catch{}
        hideGate();
      }

      if (btn){
        btn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          onConfirm();
        }, { passive:false });
      }
    })();
  </script>

  <script>
    function getScenarioFallback(){
      return {
        melderImage: "/fotos/Melder_Leer.png",
        pagerSound: ALARM_URL,
        openDelayAfterConfirmMs: 2500,
        pagerDelayAfterOpenMs: 150,

        lineDelayMs: 1400,
        charDelayMs: 70,
        afterLinePauseMs: 420,

        alarmDurationMs: 4500,

        lines: [
          "Alarm RTW 1-83-1 A08778",
          "Gehweg 29-38 (Fußgängerzone höhe Alm Klause)",
          "Unklare Lage",
          "Pol. auf Anfahrt"
        ]
      };
    }

    function getScenarioSafe(){
      try{
        if (typeof window.getActiveScenario === 'function') {
          const sc = window.getActiveScenario() || getScenarioFallback();
          if (sc && sc.pagerSound) sc.pagerSound = normalizeSoundUrl(sc.pagerSound);
          return sc;
        }
      }catch{}
      return getScenarioFallback();
    }

    const startButton   = document.getElementById("startButton");
    const melderOverlay = document.getElementById('melderOverlay');
    const melderCard    = document.querySelector('.melderCard');
    const displayEl     = document.querySelector('.display');
    const melderImg     = document.querySelector('.melderImg');
    const melderLinesEl = document.getElementById('melderLines');
    const confirmBtn    = document.getElementById('melderConfirmBtn');
    const reopenBtn     = document.getElementById('melderReopen');

    let alarmStopTimer = 0;
    let melderSequenceDone = false;
    let reopenMode = false;

    function resetAuswertungOnly() {
      try {
        const toRemove = [];
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.startsWith('time_') || k.startsWith('sichtung_') || k === 'resetFlag') {
            toRemove.push(k);
          }
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      } catch (e) {
        console.warn('resetAuswertungOnly() Fehler:', e);
      }
    }

    function setConfirmEnabled(on){
      confirmBtn.disabled = !on;
    }

    function stopAlarm(){
      try{
        if (alarmStopTimer) { clearTimeout(alarmStopTimer); alarmStopTimer = 0; }
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }catch{}
      try{
        displayEl.classList.remove('is-flicker');
        melderCard.classList.remove('is-alarming');
      }catch{}
    }

    function openMelder(){
      reopenBtn.style.display = 'none';

      if (reopenMode){
        confirmBtn.textContent = 'Schließen';
        confirmBtn.disabled = false;
      } else {
        confirmBtn.textContent = 'Status 3';
      }

      melderOverlay.classList.add('open');
      melderOverlay.setAttribute('aria-hidden','false');

      melderCard.classList.remove('is-exiting','is-hidden');
      melderCard.classList.add('is-entering');

      displayEl.classList.add('is-waking','is-flicker');

      setTimeout(()=> melderCard.classList.remove('is-entering'), 900);
      setTimeout(()=> displayEl.classList.remove('is-waking'), 2200);
    }

    function closeMelder(){
      stopAlarm();

      melderCard.classList.remove('is-entering');
      melderCard.classList.add('is-exiting');

      setTimeout(() => {
        melderOverlay.classList.remove('open');
        melderOverlay.setAttribute('aria-hidden','true');

        melderCard.classList.remove('is-exiting');
        melderCard.classList.add('is-hidden');

        setConfirmEnabled(false);

        if (melderSequenceDone) reopenBtn.style.display = 'block';
        reopenMode = false;
      }, 700);
    }

    function buildLines(lines){
      melderLinesEl.innerHTML = "";
      const nodes = [];
      for (const _ of lines){
        const d = document.createElement('div');
        d.className = 'line';
        d.textContent = '';
        melderLinesEl.appendChild(d);
        nodes.push(d);
      }
      return nodes;
    }

    async function typeLine(el, text, charDelay){
      el.textContent = '';
      const s = String(text ?? '');
      for (let i=0; i<s.length; i++){
        el.textContent += s[i];
        await wait(charDelay);
      }
    }

    async function showMelderSequence(){
      const sc = getScenarioSafe();

      if (sc.melderImage) melderImg.src = sc.melderImage;

      setConfirmEnabled(false);

      const openDelay = sc.openDelayAfterConfirmMs ?? 2500;
      await wait(openDelay);

      openMelder();

      stopAlarm();

      const pagerSound = normalizeSoundUrl(sc.pagerSound || ALARM_URL);

      try{
        alarmAudio.pause();
        alarmAudio.currentTime = 0;

        const wanted = new URL(pagerSound, location.origin).href;
        if (alarmAudio.src !== wanted) {
          alarmAudio.src = pagerSound;
          alarmAudio.load();
        }
      }catch{}

      await wait(sc.pagerDelayAfterOpenMs ?? 150);

      try{
        alarmAudio.muted = false;
        const p = alarmAudio.play();
        if (p && p.catch) p.catch(()=>{});
      }catch{}

      melderCard.classList.add('is-alarming');

      const dur = sc.alarmDurationMs ?? 4500;
      if (dur && dur > 0){
        alarmStopTimer = setTimeout(()=> stopAlarm(), dur);
      }

      const lines = Array.isArray(sc.lines) ? sc.lines : [];
      const nodes = buildLines(lines);

      const lineDelay = sc.lineDelayMs ?? 1400;
      const charDelay = sc.charDelayMs ?? 70;
      const afterLinePause = sc.afterLinePauseMs ?? 420;

      for (let i=0; i<nodes.length; i++){
        await wait(lineDelay);
        await typeLine(nodes[i], lines[i], charDelay);
        await wait(afterLinePause);
      }

      melderSequenceDone = true;
      setConfirmEnabled(true);
    }

    startButton.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      primeAllSounds();

      resetAuswertungOnly();
      startButton.style.display = "none";

      reopenMode = false;

      playPreSoundThen(async () => {
        try{
          await showMelderSequence();
        }catch(err){
          console.warn(err);
          reopenMode = false;
          openMelder();
          confirmBtn.textContent = 'Status 3';
          setConfirmEnabled(true);
        }
      });
    }, { passive: false });

    confirmBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();

      primeAllSounds();

      if (reopenMode) {
        closeMelder();
        return;
      }

      playPreSoundThen(async () => {
        closeMelder();
        const sc = getScenarioSafe();
        await wait(sc.pauseAfterConfirmMs ?? 260);
      });
    }, { passive: false });

    reopenBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();

      primeAllSounds();

      reopenMode = true;
      openMelder();
    }, { passive: false });

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.status-btn');
      if(!btn) return;
      const circle = document.createElement('span');
      circle.className = 'ripple';
      const rect = btn.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      circle.style.width = circle.style.height = size + 'px';
      circle.style.left = (e.clientX - rect.left - size/2) + 'px';
      circle.style.top  = (e.clientY - rect.top  - size/2) + 'px';
      btn.appendChild(circle);
      setTimeout(() => circle.remove(), 600);
    }, { passive: true });
  </script>

  <script>
    function resetClinicAndAssignmentsLikeEnd() {
      try {
        if (window.Ablage?.resetAll) {
          Ablage.resetAll();
        } else {
          ['ablage.active.v1','ablage.history.v1','ablage.sessionStart.v1','ablage.done.v1']
            .forEach(k => localStorage.removeItem(k));
        }

        localStorage.setItem('sichtungMap', '{}');

        const exact = new Set([
          'zuweisungMap','clinic.assignments','clinic.queue','clinic.done','meldebild',
          'blockedPages'
        ]);

        const prefixes = [
          'zuweisung_','clinic.',
          'time_','timer_','patient.','patient_','ablage.',
          'sichtung_','sicht_',
          'sperrung.','sperrung_','sperre.','sperre_',
          'pageLock.','pageLock_','lock.','lock_',
          'blocked.','blocked_','block.','block_',
          'gesperrt.','gesperrt_'
        ];

        try { window.Sperrung?.resetAll?.(); } catch(_) {}

        /* WICHTIG.
           Dynamik Keys muessen bleiben, sonst verschwindet deine Dynamik nach Status 4.
        */
        const keepExact = new Set([
          'ablage.dynamik.v1',
          'ablage.dynamik.plan.v1',
          'ablage.sessionStart.v1'
        ]);

        const toRemove = [];
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (!k) continue;

          if (k === 'sichtungMap') continue;

          if (keepExact.has(k)) continue;
          if (k.startsWith('ablage.dynamik.')) continue;

          if (exact.has(k) || prefixes.some(p => k.startsWith(p))) toRemove.push(k);
          else if (/(^|[.:_])(sperr|lock|block|gesperrt)([.:_]|$)/i.test(k)) toRemove.push(k);
        }
        toRemove.forEach(k => localStorage.removeItem(k));

        localStorage.setItem('blockedPages', '[]');

        /* resetFlag hier NICHT setzen.
           resetFlag ist fuer echten Neustart, Wert true.
           Fuer Status 4 nehmen wir einen eigenen Marker.
        */
        localStorage.setItem('status4At', String(Date.now()));
        localStorage.setItem('sperrungResetAt', String(Date.now()));
      } catch (e) {
        console.warn('Reset Fehler (Status 4):', e);
      }
    }
  </script>

  <script>
  (function wrapGetUserMediaOnce(){
    if (!navigator.mediaDevices?.getUserMedia) return;
    if (window.__gk_wrapped) return;
    const orig = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
    let allowOnce = false;
    window.__allowCameraOnce = () => { allowOnce = true; setTimeout(()=>allowOnce=false, 3000); };
    navigator.mediaDevices.getUserMedia = (c) => {
      if (!allowOnce) return Promise.reject(new DOMException('Needs user gesture','NotAllowedError'));
      allowOnce = false; return orig(c);
    };
    window.__gk_wrapped = true;
  })();

  function whenServiceWorkerReady(timeoutMs = 3000){
    return new Promise(async (resolve) => {
      let done = false;
      const fin = () => { if (!done){ done = true; resolve(true); } };
      if (navigator.serviceWorker?.controller) setTimeout(fin, 150);
      navigator.serviceWorker?.addEventListener?.('message', (ev) => {
        if (ev.data?.type === 'PRECACHE_DONE') fin();
      });
      try { await navigator.serviceWorker.ready; setTimeout(fin, 150); } catch {}
      setTimeout(()=>resolve(false), timeoutMs);
    });
  }

  function redirectFromQr(decoded){
    try {
      const u = new URL(decoded, location.origin);
      const own = new Set([location.hostname,'1rettungsmittel.de','www.1rettungsmittel.de','app.1rettungsmittel.de']);
      if (own.has(u.hostname)) {
        location.assign((u.pathname || '/').toLowerCase());
        return;
      }
      if (!navigator.onLine) { alert('Offline: Externer Link kann nicht geöffnet werden.'); return; }
      location.assign(u.href);
    } catch {
      const n = String(decoded).match(/\d+/)?.[0];
      if (n) { location.assign(('/patient'+n+'.html').toLowerCase()); return; }
      if (navigator.onLine) location.assign(String(decoded));
      else alert('Unbekanntes QR Ziel und offline.');
    }
  }

  (()=> {
    const startBtn = document.getElementById('cameraButton');
    const overlay  = document.getElementById('scannerOverlay');
    const video    = document.getElementById('scanVideo');
    const canvas   = document.getElementById('scanCanvas');
    const closeBtn = document.getElementById('scanCloseBtn');
    const ctx = canvas.getContext('2d');

    let stream = null, rAFid = 0, scanning = false, handled = false;

    async function openScanner(){
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      handled = false;

      try {
        if (typeof window.__allowCameraOnce === 'function') window.__allowCameraOnce();
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        video.srcObject = stream;
        await video.play().catch(()=>{});
        await new Promise(r => (video.readyState >= 2 ? r() : (video.onloadedmetadata = r)));

        canvas.width  = video.videoWidth  || 640;
        canvas.height = video.videoHeight || 480;

        startLoop();
        try { history.pushState({scan:true}, ''); } catch {}
      } catch (e){
        console.error('[Scanner] getUserMedia failed:', e);
        alert('Kamera konnte nicht gestartet werden. HTTPS und Berechtigungen prüfen.');
        closeScanner();
      }
    }

    function startLoop(){
      if (scanning) return;
      scanning = true;
      const tick = () => {
        if (!scanning || !stream) return;
        try{
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const img  = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = (window.jsQR)
            ? jsQR(img.data, canvas.width, canvas.height, { inversionAttempts:'dontInvert' })
            : null;

          if (code && code.data && !handled){
            handled = true;
            stopLoop(); stopTracks();
            video.pause(); video.srcObject = null;
            overlay.classList.remove('open');
            overlay.setAttribute('aria-hidden','true');
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            redirectFromQr(code.data);
            return;
          }
        } catch {}
        rAFid = requestAnimationFrame(tick);
      };
      rAFid = requestAnimationFrame(tick);
    }

    function stopLoop(){ scanning = false; if (rAFid) cancelAnimationFrame(rAFid); rAFid = 0; }
    function stopTracks(){ if (stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch{} stream=null; } }

    function closeScanner(){
      handled = false;
      stopLoop(); stopTracks();
      try { video.pause(); } catch {}
      video.srcObject = null;
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      try { const st = history.state; if (st && st.scan) history.back(); } catch {}
    }

    startBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      primeAllSounds();

      resetClinicAndAssignmentsLikeEnd();

      playPreSoundThen(async () => {
        await whenServiceWorkerReady();
        await new Promise(r => setTimeout(r, 300));
        openScanner();
      });
    }, { passive: false });

    closeBtn.addEventListener('click', closeScanner, { passive: true });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && overlay.classList.contains('open')) closeScanner(); });
    document.addEventListener('visibilitychange', () => { if (document.hidden && overlay.classList.contains('open')) closeScanner(); });
    window.addEventListener('pagehide', () => { if (overlay.classList.contains('open')) closeScanner(); });
    window.addEventListener('popstate', () => { if (overlay.classList.contains('open')) closeScanner(); });
  })();
  </script>

  <script defer src="/warmup.js?v=2025-08-23-2"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(r => console.log('SW registriert', r))
        .catch(console.error);
    }
  </script>

  <script src="/coop.js"></script>
  <script src="/metrics.js" defer></script>
</body>
</html>
