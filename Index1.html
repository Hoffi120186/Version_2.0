<script>
  const startButton = document.getElementById("startButton");
  const alarmImage  = document.getElementById("alarmImage"); // bleibt als Fallback

  const melderOverlay = document.getElementById('melderOverlay');
  const melderImgEl   = document.getElementById('melderImg');
  const melderLines   = document.getElementById('melderLines');
  const confirmBtn    = document.getElementById('melderConfirmBtn');

  // Pager-Sound (kommt aus Szenario)
  const pagerAudio = new Audio('/Alarmton2.mp3');
  pagerAudio.preload = 'auto';

  function resetAuswertungOnly() {
    try {
      const toRemove = [];
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const k = localStorage.key(i);
        if (!k) continue;
        if (k.startsWith('time_') || k.startsWith('sichtung_') || k === 'resetFlag') {
          toRemove.push(k);
        }
      }
      toRemove.forEach(k => localStorage.removeItem(k));
    } catch (e) {
      console.warn('resetAuswertungOnly() Fehler:', e);
    }
  }

  function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

  // Confirm-Beep (länger/realistischer)
  let audioCtx = null;
  function beepConfirm(){
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      o.connect(g); g.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(0.18, now + 0.03);
      g.gain.setValueAtTime(0.18, now + 0.20);
      g.gain.linearRampToValueAtTime(0.0001, now + 0.28);

      o.start(now);
      o.stop(now + 0.30);
    } catch {}
  }

  function getScenario(){
    // 1) sauber: scenarioId
    if (window.getActiveScenario) return window.getActiveScenario();

    // 2) Fallback: altes meldebild
    const img = localStorage.getItem('meldebild');
    return {
      name: 'Fallback',
      melderImage: img || '/fotos/Melder_Leer.png',
      pagerSound: '/Alarmton2.mp3',
      pauseAfterConfirmMs: 260,
      pagerDelayAfterOpenMs: 120,
      lineDelayMs: 340,
      lines: ["Alarm", "—", "—", "—", "—"]
    };
  }

  function setLines(lines){
    const nodes = [...melderLines.querySelectorAll('.line')];
    nodes.forEach((n,i) => {
      n.textContent = lines[i] || "";
      n.classList.remove('show');
    });
    return nodes;
  }

  async function playPagerShort(){
    try{
      pagerAudio.currentTime = 0;
      await pagerAudio.play();
      setTimeout(() => {
        try { pagerAudio.pause(); pagerAudio.currentTime = 0; } catch(_) {}
      }, 1200);
    } catch {}
  }

  async function showMelderSequence(){
    const sc = getScenario();

    // Bild + Sound aus Szenario
    if (sc?.melderImage) melderImgEl.src = sc.melderImage;
    if (sc?.pagerSound) pagerAudio.src = sc.pagerSound;

    // Confirm direkt (im User-Click Kontext startet es sauber)
    beepConfirm();
    await wait(sc.pauseAfterConfirmMs ?? 260);

    // Overlay auf
    melderOverlay.classList.add('isOpen');
    melderOverlay.setAttribute('aria-hidden','false');

    // Pager
    await wait(sc.pagerDelayAfterOpenMs ?? 120);
    await playPagerShort();

    // Zeilen
    const nodes = setLines(sc.lines || []);
    const delay = sc.lineDelayMs ?? 340;
    for (let i=0; i<nodes.length; i++){
      if (!nodes[i].textContent) continue;
      await wait(delay);
      nodes[i].classList.add('show');
    }
  }

  async function hideMelder(){
    melderOverlay.classList.add('isClosing');
    await wait(360);
    melderOverlay.classList.remove('isOpen','isClosing');
    melderOverlay.setAttribute('aria-hidden','true');
    [...melderLines.querySelectorAll('.line')].forEach(n => n.classList.remove('show'));
  }

  // ✅ Status 1 -> Vorsound -> Melder Overlay
  startButton.addEventListener("click", function () {
    resetAuswertungOnly();

    playPreSoundThen(async () => {
      startButton.style.display = "none";
      alarmImage.style.display = "none"; // alt aus
      await showMelderSequence();
    });
  });

  // ✅ Status 3 bestätigt nur das Overlay
  confirmBtn.addEventListener('click', async () => {
    await hideMelder();
  });

  // Ripple bleibt wie vorher
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.status-btn');
    if(!btn) return;
    const circle = document.createElement('span');
    circle.className = 'ripple';
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    circle.style.width = circle.style.height = size + 'px';
    circle.style.left = (e.clientX - rect.left - size/2) + 'px';
    circle.style.top  = (e.clientY - rect.top  - size/2) + 'px';
    btn.appendChild(circle);
    setTimeout(() => circle.remove(), 600);
  }, { passive: true });
</script>
