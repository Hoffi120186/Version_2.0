<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <title>1 Rettungsmittel V.1.0</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/LogoApp.jpg" type="image/jpeg" />

  <!-- jsQR lokal & nicht render-blockierend -->
  <script src="/vendor/jsqr.min.js" defer></script>

  <!-- Szenarien zentral -->
  <script src="/szenarien.js?v=1" defer></script>

  <!-- Lizenz-/Install-Logik (freigabe) -->
  <script src="/freigabe.js?v=2025-11-22-RETRY" defer></script>

  <style>
    /* ===== Hardening gegen iPad/Tablet Offsets ===== */
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
      margin:0;
      padding:0;
    }

    /* ✅ Hintergrund immer sofort sichtbar: auf html legen */
    html{
      min-height:100%;
      background-image:url(fotos/Leit1.jpg);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-color:#000;
    }

    /* ✅ Overlay ebenfalls auf html (Safari/iPad Fix) */
    html::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.52);
      z-index:-1;
      pointer-events:none;
    }

    body{
      font-family: Arial, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      position:relative;
    }

    /* ===== Top-Buttons ===== */
    .top-button-container{
      position:fixed;
      top:10px; left:10px; right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      z-index:1001;
      box-sizing:border-box;
    }
    @supports (padding: max(0px)) {
      .top-button-container{
        top: max(10px, env(safe-area-inset-top));
        left: max(10px, env(safe-area-inset-left));
        right: max(10px, env(safe-area-inset-right));
      }
    }

    .btn{
      padding:14px 20px;
      font-size:1.05em;
      font-weight:800;
      color:#fff;
      text-decoration:none;
      border-radius:14px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 14px 30px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.25),
        inset 0 -1px 0 rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      transform:translateY(-2px);
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 20px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.28),
        inset 0 -1px 0 rgba(0,0,0,.28);
    }
    .btn:active{
      transform:translateY(0);
      background: rgba(255,255,255,.14);
      box-shadow:
        0 14px 30px rgba(0,0,0,.45),
        inset 0 2px 10px rgba(0,0,0,.22);
    }

    main{
      width:100%;
      max-width:100%;
      margin:0 auto;
      padding-top:90px;
      box-sizing:border-box;
    }

    .image-container, .camera-container{
      width:100%;
      max-width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      box-sizing:border-box;
    }

    /* ===== Status-Buttons (Glass) ===== */
    .status-btn{
      display:block;
      width:clamp(280px, 92vw, 520px);
      padding:32px 44px;
      margin:18px auto;
      font-size:clamp(1.35rem, 4.6vw, 1.85rem);
      font-weight:900;
      line-height:1.12;
      letter-spacing:.2px;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      border:none;
      border-radius:22px;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    .status-btn::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,0,40,.28), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(255,0,40,.14), transparent 60%);
      pointer-events:none;
      opacity:.55;
    }
    .status-btn--primary{
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.28);
    }
    .status-btn--primary::before{ opacity:.75; }
    .status-btn:hover{
      transform:translateY(-3px);
      background: rgba(0,0,0,.24);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 28px 60px rgba(0,0,0,.60),
        inset 0 1px 0 rgba(255,255,255,.18);
    }
    .status-btn:active{
      transform:translateY(0);
      background: rgba(0,0,0,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 2px 12px rgba(0,0,0,.30);
    }

    /* Ripple */
    .status-btn .ripple{
      position:absolute;
      border-radius:50%;
      background:rgba(255,255,255,.40);
      transform:scale(0);
      animation:ripple .6s linear;
      pointer-events:none;
    }
    @keyframes ripple{ to{ transform:scale(4); opacity:0; } }

    /* ===== Melder Overlay (Status 1) ===== */
    .melder-overlay{
      position:fixed;
      inset:0;
      z-index:9998;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 18px;
      box-sizing:border-box;
    }
    .melder-overlay.open{ display:flex; }

    .melder-wrap{
      width: min(92vw, 560px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 16px;
    }

    .melderCard{
      position:relative;
      width: 100%;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 24px 70px rgba(0,0,0,.65);
      transform: translateY(10px);
      opacity: 0;
    }

    /* Das ist dein "leer" Melder-Bild (nur Gerät, ohne Text) */
    .melderImg{
      width:100%;
      height:auto;
      display:block;
      border-radius: 18px;
    }

    /* LCD Display: final Werte + dein "unten noch bisschen mehr" */
    .display{
      position:absolute;
      left: 18.0%;
      top: 28.3%;
      width: 64.8%;
      height: 38.6%;            /* ✅ unten noch ein kleines Stück mehr */
      border-radius: 10px;
      overflow:hidden;

      background: radial-gradient(circle at 30% 30%, rgba(210,255,120,.95), rgba(170,220,70,.90));
      box-shadow:
        0 0 0 1px rgba(0,0,0,.18),
        0 10px 20px rgba(0,0,0,.25),
        0 0 28px rgba(180,255,120,.35);
      filter: saturate(1.05) contrast(1.06);
    }

    /* leichte "Scheibe/Glanz" */
    .display::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 12px rgba(0,0,0,.22);
    }

    .lines{
      position:absolute;
      inset: 10% 6% 10% 6%;
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-weight: 900;
      color:#000;
      font-size: clamp(12px, 2.8vw, 16px);
      line-height: 1.15;
      text-align:left;
    }

    .line{
      white-space: normal;
      word-break: break-word;
      min-height: 1em;
    }

    /* Status 3 Button im gleichen Glass-Style */
    .melderConfirm{
      width: min(92vw, 520px);
      padding: 20px 18px;
      border-radius: 22px;

      color:#fff;
      font-weight: 900;
      font-size: clamp(18px, 4.6vw, 22px);
      letter-spacing: .2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);

      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.16);

      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      cursor:pointer;
      user-select:none;

      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .melderConfirm:hover{
      transform: translateY(-2px);
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 28px 60px rgba(0,0,0,.60),
        inset 0 1px 0 rgba(255,255,255,.18);
    }
    .melderConfirm:active{
      transform: translateY(0);
      background: rgba(0,0,0,.20);
      box-shadow:
        0 18px 44px rgba(0,0,0,.55),
        inset 0 2px 12px rgba(0,0,0,.30);
    }
    .melderConfirm:disabled{
      opacity:.55;
      cursor: default;
      transform:none;
    }

    /* --- Melder Realismus --- */
    @keyframes pagerEnter {
      0%   { transform: translateY(22px) scale(.985); opacity: 0; filter: blur(2px); }
      60%  { transform: translateY(-2px) scale(1.0);  opacity: 1; filter: blur(0); }
      100% { transform: translateY(0) scale(1.0); }
    }
    @keyframes pagerShake {
      0%{ transform: translate(0,0) }
      15%{ transform: translate(-1px, 1px) }
      30%{ transform: translate(2px, -1px) }
      45%{ transform: translate(-2px, 0) }
      60%{ transform: translate(2px, 1px) }
      75%{ transform: translate(-1px, -1px) }
      100%{ transform: translate(0,0) }
    }
    @keyframes lcdPulse {
      0%   { filter: brightness(1.00) saturate(1.02) contrast(1.05); }
      20%  { filter: brightness(1.14) saturate(1.10) contrast(1.07); }
      45%  { filter: brightness(0.98) saturate(1.00) contrast(1.06); }
      70%  { filter: brightness(1.10) saturate(1.08) contrast(1.07); }
      100% { filter: brightness(1.00) saturate(1.02) contrast(1.05); }
    }
    @keyframes lcdFlicker {
      0%, 100% { opacity: 1; }
      48% { opacity: .985; }
      50% { opacity: .96; }
      52% { opacity: .99; }
    }

    .melderCard.is-entering{
      animation: pagerEnter .42s ease-out both, pagerShake .35s ease-in-out .06s both;
    }
    .display.is-waking{
      animation: lcdPulse 1.6s ease-in-out both;
    }
    .display.is-flicker::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      mix-blend-mode: overlay;
      opacity:.12;
      animation: lcdFlicker 1.4s linear infinite;
    }

    /* ===== Scanner-Overlay ===== */
    .scan-overlay{
      position:fixed; inset:0; z-index:9999;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.85);
    }
    .scan-overlay.open{ display:flex; }
    .scan-ui{ position:relative; width:min(100vw,800px); height:min(100vh,1000px); padding:12px; box-sizing:border-box; }
    #scanVideo{ width:100%; height:100%; object-fit:cover; background:#000; border-radius:10px; }
    .scan-topbar{
      position:absolute; top:10px; right:10px; left:10px;
      display:flex; justify-content:flex-end; gap:8px; pointer-events:none;
    }
    .scan-close{
      pointer-events:auto; font-size:32px; line-height:1; padding:8px 12px;
      border:none; border-radius:12px; color:#fff;
      background:rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
    }
    .scan-close:hover{ background:rgba(255,255,255,.20); border-color: rgba(255,255,255,.30); }
    .scan-frame{
      position:absolute; inset:15% 10%;
      border:3px solid rgba(255,255,255,.7); border-radius:12px; pointer-events:none;
    }
  </style>

  <link rel="stylesheet" href="/app-flow.css">
</head>

<body>

  <div class="top-button-container">
    <a href="/instruktor.html" class="btn">Instruktor</a>
    <a href="/index.html" class="btn">Startseite</a>
  </div>

  <main>
    <div class="image-container">
      <button id="startButton" class="status-btn">
        Status 1<br>Fahrzeug einsatzbereit
      </button>
    </div>

    <div class="camera-container">
      <button id="cameraButton" class="status-btn status-btn--primary">
        Status 4<br>Fahrzeug Einsatzstelle<br>erreicht
      </button>
    </div>
  </main>

  <!-- ===== Melder Overlay ===== -->
  <div id="melderOverlay" class="melder-overlay" aria-hidden="true">
    <div class="melder-wrap">

      <div class="melderCard">
        <!-- ✅ DEIN leeres Melder-Bild -->
        <img class="melderImg" src="/fotos/Melder_Leer.png" alt="Melder">

        <!-- ✅ LCD Bereich -->
        <div class="display">
          <div id="melderLines" class="lines"></div>
        </div>
      </div>

      <button id="melderConfirmBtn" class="melderConfirm" disabled>Status 3</button>

    </div>
  </div>

  <!-- ===== Scanner-Overlay ===== -->
  <div id="scannerOverlay" class="scan-overlay" aria-hidden="true">
    <div class="scan-ui">
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" hidden></canvas>
      <div class="scan-frame"></div>
      <div class="scan-topbar">
        <button id="scanCloseBtn" class="scan-close" aria-label="Scanner schließen">×</button>
      </div>
    </div>
  </div>

  <!-- ✅ Vorsound (Confirm-Beep) -->
  <script>
    // status1_pre.mp3 liegt im gleichen Ordner wie index1.html
    const PRE_URL = new URL('status1_pre.mp3', location.href).href;
    const audioPre = new Audio(PRE_URL);
    audioPre.preload = 'auto';

    function playPreSoundThen(nextFn){
      audioPre.onended = null;
      audioPre.onerror = null;

      const done = () => {
        audioPre.onended = null;
        audioPre.onerror = null;
        try { nextFn && nextFn(); } catch(e){ console.warn(e); }
      };

      audioPre.onended = done;
      audioPre.onerror = done;

      try{ audioPre.pause(); audioPre.currentTime = 0; } catch {}
      audioPre.play().catch(() => done());
    }

    const wait = (ms)=> new Promise(r => setTimeout(r, ms));
  </script>

  <!-- ===== Status 1: Melder-Sequence ===== -->
  <script>
    // Fallback falls szenarien.js mal nicht lädt
    function getScenarioFallback(){
      return {
        melderImage: "/fotos/Melder_Leer.png",
        pagerSound: "/Alarmton2.mp3",
        openDelayAfterConfirmMs: 2500,  // ✅ 2.5s Pause nach Confirm-Beep
        pagerDelayAfterOpenMs: 150,
        lineDelayMs: 1400,
        charDelayMs: 55,
        afterLinePauseMs: 320,
        // optional: alarmDurationMs: 6500,
        lines: [
          "Alarm RTW 1-83-1 A08778",
          "Gehweg 29-38 (Fußgängerzone höhe Alm Klause)",
          "Unklare Lage",
          "Pol. auf Anfahrt"
        ]
      };
    }

    function getScenarioSafe(){
      try{
        if (typeof window.getActiveScenario === 'function') {
          return window.getActiveScenario() || getScenarioFallback();
        }
      }catch{}
      return getScenarioFallback();
    }

    const startButton = document.getElementById("startButton");

    const melderOverlay = document.getElementById('melderOverlay');
    const melderCard    = document.querySelector('.melderCard');
    const displayEl     = document.querySelector('.display');
    const melderImg     = document.querySelector('.melderImg');
    const melderLinesEl = document.getElementById('melderLines');
    const confirmBtn    = document.getElementById('melderConfirmBtn');

    let alarmAudio = null;
    let alarmStopTimer = 0;

    function resetAuswertungOnly() {
      try {
        const toRemove = [];
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.startsWith('time_') || k.startsWith('sichtung_') || k === 'resetFlag') {
            toRemove.push(k);
          }
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      } catch (e) {
        console.warn('resetAuswertungOnly() Fehler:', e);
      }
    }

    function stopAlarm(){
      try{
        if (alarmStopTimer) { clearTimeout(alarmStopTimer); alarmStopTimer = 0; }
        if (alarmAudio){
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
        }
      }catch{}
    }

    function openMelder(){
      melderOverlay.classList.add('open');
      melderOverlay.setAttribute('aria-hidden','false');

      // Realismus
      melderCard.classList.add('is-entering');
      displayEl.classList.add('is-waking','is-flicker');
      setTimeout(()=> melderCard.classList.remove('is-entering'), 650);
      setTimeout(()=> displayEl.classList.remove('is-waking'), 1700);
    }

    function closeMelder(){
      stopAlarm();
      melderOverlay.classList.remove('open');
      melderOverlay.setAttribute('aria-hidden','true');
    }

    function setConfirmEnabled(on){
      confirmBtn.disabled = !on;
    }

    function clearLines(){
      melderLinesEl.innerHTML = "";
    }

    function buildLines(lines){
      clearLines();
      const nodes = [];
      for (const _ of lines){
        const d = document.createElement('div');
        d.className = 'line';
        d.textContent = '';
        melderLinesEl.appendChild(d);
        nodes.push(d);
      }
      return nodes;
    }

    async function typeLine(el, text, charDelay){
      el.textContent = '';
      const s = String(text ?? '');
      for (let i=0; i<s.length; i++){
        el.textContent += s[i];
        await wait(charDelay);
      }
    }

    async function showMelderSequence(){
      const sc = getScenarioSafe();

      // Optional: wenn du pro Szenario später ein anderes leeres Melder-Bild willst
      if (sc.melderImage) melderImg.src = sc.melderImage;

      // Button erst aktiv wenn Text fertig
      setConfirmEnabled(false);

      // 2.5s Pause nach Confirm-Beep (einstellbar)
      const openDelay = sc.openDelayAfterConfirmMs ?? 2500;
      await wait(openDelay);

      openMelder();

      // Alarm-Sound
      stopAlarm();
      alarmAudio = new Audio(sc.pagerSound || '/Alarmton2.mp3');
      alarmAudio.preload = 'auto';

      // Start Alarm minimal verzögert (fühlt sich echter an)
      await wait(sc.pagerDelayAfterOpenMs ?? 150);
      alarmAudio.play().catch(()=>{});

      // Optional: Alarm nach X ms stoppen (wenn gesetzt)
      if (sc.alarmDurationMs){
        alarmStopTimer = setTimeout(()=> stopAlarm(), sc.alarmDurationMs);
      }

      // Text: langsam + Schreibmaschine
      const lines = Array.isArray(sc.lines) ? sc.lines : [];
      const nodes = buildLines(lines);

      const lineDelay = sc.lineDelayMs ?? 1400;
      const charDelay = sc.charDelayMs ?? 55;
      const afterLinePause = sc.afterLinePauseMs ?? 320;

      for (let i=0; i<nodes.length; i++){
        await wait(lineDelay);
        await typeLine(nodes[i], lines[i], charDelay);
        await wait(afterLinePause);
      }

      // Jetzt erst bestätigen erlauben
      setConfirmEnabled(true);
    }

    // Status 1: Confirm-Beep -> Pause -> Melder + Text
    startButton.addEventListener("click", () => {
      resetAuswertungOnly();
      startButton.style.display = "none";

      playPreSoundThen(async () => {
        try{
          await showMelderSequence();
        }catch(e){
          console.warn(e);
          // fallback: Overlay trotzdem öffnen
          openMelder();
          setConfirmEnabled(true);
        }
      });
    });

    // Status 3: nur Overlay schließen (Rest bleibt)
    confirmBtn.addEventListener('click', async () => {
      const sc = getScenarioSafe();
      closeMelder();
      // kleine Pause nach Confirm (optional)
      await wait(sc.pauseAfterConfirmMs ?? 260);
    });

    // Overlay Klick außerhalb -> NICHT schließen (damit realistisch)
    // Wenn du willst, dass es doch schließt: hier aktivieren.
    // melderOverlay.addEventListener('click', (e)=>{ if(e.target===melderOverlay) closeMelder(); });

    // Ripple Effekt wie bei dir
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.status-btn');
      if(!btn) return;
      const circle = document.createElement('span');
      circle.className = 'ripple';
      const rect = btn.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      circle.style.width = circle.style.height = size + 'px';
      circle.style.left = (e.clientX - rect.left - size/2) + 'px';
      circle.style.top  = (e.clientY - rect.top  - size/2) + 'px';
      btn.appendChild(circle);
      setTimeout(() => circle.remove(), 600);
    }, { passive: true });
  </script>

  <!-- ===== Reset für Status 4 (wie bei dir) ===== -->
  <script>
    function resetClinicAndAssignmentsLikeEnd() {
      try {
        if (window.Ablage?.resetAll) {
          Ablage.resetAll();
        } else {
          ['ablage.active.v1','ablage.history.v1','ablage.sessionStart.v1','ablage.done.v1']
            .forEach(k => localStorage.removeItem(k));
        }
        localStorage.setItem('sichtungMap', '{}');

        const exact = new Set([
          'zuweisungMap','clinic.assignments','clinic.queue','clinic.done','meldebild',
          'blockedPages'
        ]);

        const prefixes = [
          'zuweisung_','clinic.',
          'time_','timer_','patient.','patient_','ablage.',
          'sichtung_','sicht_',
          'sperrung.','sperrung_','sperre.','sperre_',
          'pageLock.','pageLock_','lock.','lock_',
          'blocked.','blocked_','block.','block_',
          'gesperrt.','gesperrt_'
        ];

        try { window.Sperrung?.resetAll?.(); } catch(_) {}

        const toRemove = [];
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i); if (!k) continue;
          if (k === 'sichtungMap') continue;
          if (exact.has(k) || prefixes.some(p => k.startsWith(p))) toRemove.push(k);
          else if (/(^|[.:_])(sperr|lock|block|gesperrt)([.:_]|$)/i.test(k)) toRemove.push(k);
        }
        toRemove.forEach(k => localStorage.removeItem(k));

        localStorage.setItem('blockedPages', '[]');
        localStorage.setItem('resetFlag', String(Date.now()));
        localStorage.setItem('sperrungResetAt', String(Date.now()));
      } catch (e) {
        console.warn('Reset-Fehler (Status 4):', e);
      }
    }
  </script>

  <!-- ===== Scanner (wie bei dir) ===== -->
  <script>
  (function wrapGetUserMediaOnce(){
    if (!navigator.mediaDevices?.getUserMedia) return;
    if (window.__gk_wrapped) return;
    const orig = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
    let allowOnce = false;
    window.__allowCameraOnce = () => { allowOnce = true; setTimeout(()=>allowOnce=false, 3000); };
    navigator.mediaDevices.getUserMedia = (c) => {
      if (!allowOnce) return Promise.reject(new DOMException('Needs user gesture','NotAllowedError'));
      allowOnce = false; return orig(c);
    };
    window.__gk_wrapped = true;
  })();

  function whenServiceWorkerReady(timeoutMs = 3000){
    return new Promise(async (resolve) => {
      let done = false;
      const fin = () => { if (!done){ done = true; resolve(true); } };
      if (navigator.serviceWorker?.controller) setTimeout(fin, 150);
      navigator.serviceWorker?.addEventListener?.('message', (ev) => {
        if (ev.data?.type === 'PRECACHE_DONE') fin();
      });
      try { await navigator.serviceWorker.ready; setTimeout(fin, 150); } catch {}
      setTimeout(()=>resolve(false), timeoutMs);
    });
  }

  function redirectFromQr(decoded){
    try {
      const u = new URL(decoded, location.origin);
      const own = new Set([location.hostname,'1rettungsmittel.de','www.1rettungsmittel.de','app.1rettungsmittel.de']);
      if (own.has(u.hostname)) {
        location.assign((u.pathname || '/').toLowerCase());
        return;
      }
      if (!navigator.onLine) { alert('Offline: Externer Link kann nicht geöffnet werden.'); return; }
      location.assign(u.href);
    } catch {
      const n = String(decoded).match(/\d+/)?.[0];
      if (n) { location.assign(('/patient'+n+'.html').toLowerCase()); return; }
      if (navigator.onLine) location.assign(String(decoded));
      else alert('Unbekanntes QR-Ziel und offline.');
    }
  }

  (()=> {
    const startBtn = document.getElementById('cameraButton');
    const overlay  = document.getElementById('scannerOverlay');
    const video    = document.getElementById('scanVideo');
    const canvas   = document.getElementById('scanCanvas');
    const closeBtn = document.getElementById('scanCloseBtn');
    const ctx = canvas.getContext('2d');

    let stream = null, rAFid = 0, scanning = false, handled = false;

    async function openScanner(){
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      handled = false;

      try {
        if (typeof window.__allowCameraOnce === 'function') window.__allowCameraOnce();
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        video.srcObject = stream;
        await video.play().catch(()=>{});
        await new Promise(r => (video.readyState >= 2 ? r() : (video.onloadedmetadata = r)));

        canvas.width  = video.videoWidth  || 640;
        canvas.height = video.videoHeight || 480;

        startLoop();
        try { history.pushState({scan:true}, ''); } catch {}
      } catch (e){
        console.error('[Scanner] getUserMedia failed:', e);
        alert('Kamera konnte nicht gestartet werden. HTTPS & Berechtigungen prüfen.');
        closeScanner();
      }
    }

    function startLoop(){
      if (scanning) return;
      scanning = true;
      const tick = () => {
        if (!scanning || !stream) return;
        try{
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const img  = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = (window.jsQR)
            ? jsQR(img.data, canvas.width, canvas.height, { inversionAttempts:'dontInvert' })
            : null;

          if (code && code.data && !handled){
            handled = true;
            stopLoop(); stopTracks();
            video.pause(); video.srcObject = null;
            overlay.classList.remove('open');
            overlay.setAttribute('aria-hidden','true');
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            redirectFromQr(code.data);
            return;
          }
        } catch {}
        rAFid = requestAnimationFrame(tick);
      };
      rAFid = requestAnimationFrame(tick);
    }

    function stopLoop(){ scanning = false; if (rAFid) cancelAnimationFrame(rAFid); rAFid = 0; }
    function stopTracks(){ if (stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch{} stream=null; } }

    function closeScanner(){
      handled = false;
      stopLoop(); stopTracks();
      try { video.pause(); } catch {}
      video.srcObject = null;
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      try { const st = history.state; if (st && st.scan) history.back(); } catch {}
    }

    startBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      resetClinicAndAssignmentsLikeEnd();

      playPreSoundThen(async () => {
        await whenServiceWorkerReady();
        await new Promise(r => setTimeout(r, 300));
        openScanner();
      });
    }, { passive: false });

    closeBtn.addEventListener('click', closeScanner, { passive: true });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && overlay.classList.contains('open')) closeScanner(); });
    document.addEventListener('visibilitychange', () => { if (document.hidden && overlay.classList.contains('open')) closeScanner(); });
    window.addEventListener('pagehide', () => { if (overlay.classList.contains('open')) closeScanner(); });
    window.addEventListener('popstate', () => { if (overlay.classList.contains('open')) closeScanner(); });
  })();
  </script>

  <!-- Warmup -->
  <script defer src="/warmup.js?v=2025-08-23-2"></script>

  <!-- SW-Registrierung -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(r => console.log('SW registriert', r))
        .catch(console.error);
    }
  </script>

  <script src="/coop.js"></script>
  <script src="/metrics.js" defer></script>
</body>
</html>
