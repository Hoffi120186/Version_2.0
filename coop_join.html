<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Coop Übung beitreten</title>

  <style>
    :root{
      --bg:#0b0f1a;
      --card:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.20);
      --ok:#22c55e;
      --bad:#ef4444;
      --muted:rgba(255,255,255,.75);
      --shadow:0 10px 26px rgba(0,0,0,.28);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(720px,100%)}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    h1{margin:0 0 10px;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      font-weight:700;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .muted{color:var(--muted)}
    .box{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;align-items:center}
    .kv div{padding:2px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.12);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.22);
      transition:.15s;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.18)}
    .btn.danger{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.16)}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}
    .msg{margin-top:10px;font-weight:700}
    .msg.ok{color:#86efac}
    .msg.bad{color:#fca5a5}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.28);
      color:#fff;
      font-size:16px;
    }
    .footer{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .hint{margin-top:10px;font-size:13px;color:rgba(255,255,255,.7)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h1>Coop Übung beitreten</h1>
        <div id="statusPill" class="pill">
          <span id="statusDot" class="dot bad"></span>
          <span id="statusText">Coop inaktiv</span>
        </div>
      </div>

      <div class="muted">
        Server Ziel ist fest auf <span class="mono" id="baseShow"></span>
      </div>

      <div class="box">
        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:220px">
            <div class="muted" style="margin-bottom:6px">Join Code</div>
            <input
              id="codeIn"
              type="text"
              inputmode="text"
              autocomplete="off"
              autocapitalize="characters"
              autocorrect="off"
              spellcheck="false"
              placeholder="z.B. A1B2C3"
            />
          </div>
          <div style="flex:1; min-width:220px">
            <div class="muted" style="margin-bottom:6px">Name</div>
            <input id="nameIn" autocomplete="name" placeholder="z.B. RTW 1" />
          </div>
        </div>

        <div class="footer">
          <button id="btnJoin" class="btn primary" type="button">Beitreten</button>
          <button id="btnEnd" class="btn danger" type="button" disabled>Coop beenden</button>
          <button id="btnBack" class="btn ghost" type="button">Zurück</button>
        </div>

        <div id="msg" class="msg muted"></div>
        <div class="hint">Tipp. Am einfachsten per QR Code. Dann ist der Join Code schon eingetragen.</div>
      </div>

      <div class="box">
        <div class="kv">
          <div class="muted">Incident</div><div class="mono" id="incidentOut">leer</div>
          <div class="muted">Rolle</div><div class="mono" id="roleOut">leer</div>
          <div class="muted">Token</div><div class="mono" id="tokenOut">leer</div>
        </div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div class="muted">Kurztest</div>
          <button id="btnPing" class="btn" type="button">Ping prüfen</button>
        </div>
        <div id="pingMsg" class="msg muted"></div>
      </div>
    </div>
  </div>

  <script>
    const BASEURL = "https://192.168.4.1:3443";

    const baseShow = document.getElementById("baseShow");
    const codeIn = document.getElementById("codeIn");
    const nameIn = document.getElementById("nameIn");

    const incidentOut = document.getElementById("incidentOut");
    const roleOut = document.getElementById("roleOut");
    const tokenOut = document.getElementById("tokenOut");

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const msg = document.getElementById("msg");
    const pingMsg = document.getElementById("pingMsg");

    const btnJoin = document.getElementById("btnJoin");
    const btnEnd = document.getElementById("btnEnd");
    const btnBack = document.getElementById("btnBack");
    const btnPing = document.getElementById("btnPing");

    baseShow.textContent = BASEURL;

    function readSession(){
      try { return JSON.parse(localStorage.getItem("coop_session_v1") || "null"); }
      catch { return null; }
    }
    function writeSession(s){
      localStorage.setItem("coop_session_v1", JSON.stringify(s));
    }
    function clearSession(){
      localStorage.removeItem("coop_session_v1");
    }

    function setStatus(active){
      statusDot.className = "dot " + (active ? "ok" : "bad");
      statusText.textContent = active ? "Coop aktiv" : "Coop inaktiv";
    }

    function render(){
      const s = readSession();
      const active = !!(s && s.baseUrl && s.incident_id && s.token);
      setStatus(active);

      incidentOut.textContent = s && s.incident_id ? s.incident_id : "leer";
      roleOut.textContent = s && s.role ? s.role : "leer";
      tokenOut.textContent = s && s.token ? (String(s.token).slice(0,6) + "…") : "leer";

      btnEnd.disabled = !active;
    }

    function prefillFromUrl(){
      try{
        const u = new URL(location.href);
        const code = (u.searchParams.get("code") || "").trim();
        const name = (u.searchParams.get("name") || "").trim();
        if (code) codeIn.value = code.toUpperCase();
        if (name) nameIn.value = name;

        const auto = (u.searchParams.get("auto") || "").trim();
        if (auto === "1" && code) {
          setTimeout(() => btnJoin.click(), 250);
        }
      }catch{}
    }

    async function ping(){
      pingMsg.className = "msg muted";
      pingMsg.textContent = "Ping läuft";
      try{
        const r = await fetch(BASEURL + "/ping?ts=" + Date.now(), { cache:"no-store" });
        const t = await r.text();
        if (!r.ok) throw new Error("HTTP " + r.status + " " + t);
        pingMsg.className = "msg ok";
        pingMsg.textContent = "OK " + t;
      }catch(e){
        pingMsg.className = "msg bad";
        pingMsg.textContent = "Ping fehlgeschlagen. " + (e && e.message ? e.message : e);
      }
    }

    btnPing.addEventListener("click", ping);

    btnJoin.addEventListener("click", async ()=>{
  msg.className = "msg muted";
  msg.textContent = "Beitritt läuft";
  btnJoin.disabled = true;

  const join_code = String(codeIn.value || "").trim().toUpperCase();

  const roleRaw = String(nameIn.value || "").trim().toUpperCase();
  const role = (roleRaw.includes("ORGL") ? "ORGL" : roleRaw.includes("NEF") ? "NEF" : "RTW");

  if (!/^[A-Z0-9]{6}$/.test(join_code)){
    msg.className = "msg bad";
    msg.textContent = "Join Code ist ungültig. Er hat 6 Zeichen, Buchstaben und Zahlen.";
    btnJoin.disabled = false;
    return;
  }

  try{
    const r = await fetch(BASEURL + "/incident/join", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ join_code, role })
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || j.ok !== true) {
      const err = j && j.error ? j.error : ("HTTP " + r.status);
      throw new Error(err);
    }

    writeSession({
      incident_id: j.incident_id,
      token: j.token,
      role: j.role,
      displayName: j.displayName || role,
      baseUrl: BASEURL,
      base: BASEURL
    });

    msg.className = "msg ok";
    msg.textContent = "Beigetreten. Du kannst jetzt normal sichten.";
    render();
  }catch(e){
    msg.className = "msg bad";
    msg.textContent = "Fehler. " + (e?.message || e);
  }finally{
    btnJoin.disabled = false;
  }
});


    btnEnd.addEventListener("click", ()=>{
      clearSession();
      msg.className = "msg ok";
      msg.textContent = "Coop beendet. LocalStorage Session wurde gelöscht.";
      render();
    });

    btnBack.addEventListener("click", ()=>{
      history.back();
    });

    prefillFromUrl();
    render();
  </script>
</body>
</html>
