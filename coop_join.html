<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coop – Beitreten</title>
</head>
<body style="font-family:system-ui;padding:16px">
  <h1>Coop – Übung beitreten</h1>

  <label>Server-URL:</label><br>
  <input id="base" style="width:100%;padding:10px" value="http://raspberry:3000"><br><br>

  <label>Join-Code:</label><br>
  <input id="code" style="width:100%;padding:10px"><br><br>

  <label>Rolle:</label><br>
  <select id="role" style="width:100%;padding:10px">
    <option>RTW</option>
    <option>NEF</option>
    <option>ORGL</option>
  </select><br><br>

  <button id="join" style="padding:12px 16px;font-weight:700">Beitreten</button>

  <div id="out" style="margin-top:16px"></div>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const pre = qs.get('code') || '';
    document.getElementById('code').value = pre;

    const out = document.getElementById('out');

    document.getElementById('join').onclick = async () => {
      out.textContent = 'Trete bei...';
      try{
        const baseUrl = document.getElementById('base').value.trim().replace(/\/$/,'');
        const join_code = document.getElementById('code').value.trim().toUpperCase();
        const role = document.getElementById('role').value;

        const res = await fetch(baseUrl + '/incident/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ join_code, role })
        });
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data?.error || 'join_failed');

        localStorage.setItem('coop_session_v1', JSON.stringify({
          baseUrl,
          incident_id: data.incident_id,
          token: data.token,
          role
        }));

        out.innerHTML = `
          <p>✅ Beigetreten als <b>${role}</b></p>
          <p><button onclick="location.href='index1.html'" style="padding:12px 16px;font-weight:700">Start</button></p>
        `;
      }catch(e){
        out.textContent = 'Fehler: ' + (e?.message || e);
      }
    };
  })();
  </script>
</body>
</html>
