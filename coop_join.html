<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coop beitreten</title>
  <style>
    body{font-family:system-ui;margin:18px;background:#0b0f1a;color:#fff}
    .card{max-width:720px;margin:0 auto;background:rgba(255,255,255,.08);padding:16px;border-radius:14px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.25);color:#fff;margin-top:10px}
    button{background:#0B5FFF;border:none;font-weight:800;cursor:pointer}
    .muted{opacity:.8;font-size:13px}
    .ok{color:#7CFC98}
    .warn{color:#FFD27A}
  </style>
</head>
<body>
  <div class="card">
    <h2>Coop beitreten</h2>
    <div class="muted">Wenn du per QR hier bist, sind BaseURL & Join-Code schon gesetzt.</div>

    <label>Server BaseURL (HTTPS)</label>
    <input id="baseUrl" placeholder="https://192.168.x.x:3443" />

    <label>Join-Code</label>
    <input id="code" placeholder="ABC123" />

    <label>Rolle</label>
    <select id="role">
      <option value="RTW">RTW</option>
      <option value="NEF">NEF</option>
      <option value="ORGL">OrgL</option>
    </select>

    <label>Name (optional)</label>
    <input id="name" placeholder="RTW 1" />

    <button id="btnJoin">Beitreten</button>

    <div id="out" style="margin-top:12px"></div>
  </div>

  <script src="/coop-client.js" defer></script>
  <script>
    function $(id){return document.getElementById(id);}
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}

    // Params 端bernehmen
    const qs = new URLSearchParams(location.search);
    const base = qs.get('base'); const code = qs.get('code');
    if (base) $('baseUrl').value = base;
    if (code) $('code').value = code;

    $('btnJoin').onclick = async ()=>{
      const baseUrl = $('baseUrl').value.trim().replace(/\/$/,'');
      const join_code = $('code').value.trim().toUpperCase();
      const role = $('role').value;
      const name = $('name').value.trim();

      if(!baseUrl || !join_code){
        $('out').innerHTML = '<div class="warn">Bitte BaseURL und Join-Code ausf端llen.</div>';
        return;
      }

      try{
        const res = await fetch(baseUrl + '/incident/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ join_code, role, name })
        });
        const data = await res.json().catch(()=>null);
        if(!res.ok || !data?.ok) throw new Error(data?.error || ('http_'+res.status));

        // Session speichern
        window.Coop?.saveSession?.({
          baseUrl,
          incident_id: data.incident_id,
          token: data.token,
          role
        });

        $('out').innerHTML = `<div class="ok"><b>Verbunden.</b></div>
          <div class="muted">Du kannst jetzt in die App zur端ck.</div>`;

        // RTW: zur端ck in Haupt-App (oder patienten-qr / index1)
        setTimeout(()=> location.href = 'index1.html', 500);

      }catch(e){
        $('out').innerHTML = `<div class="warn">Fehler: ${escapeHtml(e.message || e)}</div>`;
      }
    };
  </script>
</body>
</html>
