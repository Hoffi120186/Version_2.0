<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Dynamik</title>
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0b0f1a" />

  <style>
    :root{
      --w:min(96vw,980px);
      --bg:#0b0f1a;
      --glass:rgba(255,255,255,.10);
      --glass2:rgba(255,255,255,.14);
      --border:rgba(255,255,255,.18);
      --shadow:0 10px 26px rgba(0,0,0,.28);
      --shadow2:0 18px 60px rgba(0,0,0,.55);
      --accent:#0B5FFF;
      --danger:#e53935;
      --ok:#2e7d32;
      --warn:#f3fc02;
      --tap:54px;
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#fff;
      min-height:100vh;
      padding-bottom:92px;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 650px at 85% 25%, rgba(229,57,53,.16), transparent 60%),
        radial-gradient(900px 650px at 45% 90%, rgba(46,125,50,.14), transparent 60%),
        rgba(0,0,0,.35);
      z-index:-1;
    }

    header{
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:12px;
      background:rgba(0,0,0,.58);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    header h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px}
    .btn{
      min-height:var(--tap);
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(255,255,255,.12);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow:var(--shadow);
      user-select:none;
    }
    .btn.primary{
      background:linear-gradient(180deg, rgba(11,95,255,1), rgba(11,95,255,.78));
      border-color:rgba(255,255,255,.22);
    }
    .btn.danger{ background:linear-gradient(180deg, rgba(229,57,53,1), rgba(183,28,28,.95)); }
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .wrap{
      width:var(--w);
      margin:0 auto;
      padding:14px 12px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .muted{opacity:.86}
    .line{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .grid2{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
    }
    label{display:block;font-size:13px;opacity:.9;font-weight:800;margin:0 0 6px 0}
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      font-weight:900;
      font-size:13px;
      min-height:40px;
      user-select:none;
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
    }
    .toggle .tTitle{font-weight:900}
    .toggle .tSub{font-size:12px;opacity:.86;margin-top:2px;line-height:1.25}

    .switch{
      width:58px;height:34px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.10);
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
    }
    .switch::after{
      content:"";
      width:28px;height:28px;border-radius:999px;
      background:rgba(255,255,255,.86);
      position:absolute;
      top:2px;left:2px;
      transition:transform .16s ease, background .16s ease;
    }
    .switch.on{
      background:rgba(11,95,255,.22);
      border-color:rgba(11,95,255,.55);
    }
    .switch.on::after{
      transform:translateX(24px);
      background:rgba(11,95,255,.95);
    }

    .rangeBox{
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
    }
    .rangeLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .kv{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 11px;
      border-radius:999px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      font-variant-numeric:tabular-nums;
    }
    input[type="range"]{ width:100%; accent-color:var(--accent); }

    .presetRow{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
    }
    .presetBtn{
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      min-height:72px;
      text-align:left;
      font-weight:900;
      box-shadow:var(--shadow);
    }
    .presetBtn small{display:block;opacity:.86;font-weight:700;margin-top:2px;line-height:1.2}
    .presetBtn.active{
      border-color:rgba(11,95,255,.75);
      box-shadow:0 0 0 2px rgba(11,95,255,.18), var(--shadow);
      background:rgba(11,95,255,.12);
    }

    .choiceRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .choice{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      min-height:70px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .choice strong{font-size:14px}
    .choice small{opacity:.86;line-height:1.2}
    .choice.active{
      border-color:rgba(11,95,255,.75);
      background:rgba(11,95,255,.12);
      box-shadow:0 0 0 2px rgba(11,95,255,.18), var(--shadow);
    }

    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      min-height:var(--tap);
    }
    .stepper button{
      width:48px;height:48px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
    }
    .stepper .val{
      font-weight:900;
      font-size:18px;
      min-width:64px;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    .stepper .hint{
      margin-left:auto;
      font-size:12px;
      opacity:.86;
      text-align:right;
      line-height:1.15;
    }

    .status{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background:#9aa0a6;
      margin-top:4px;
      box-shadow:0 0 0 2px rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--danger)}
    .status .msg{font-weight:900}
    .status .msg small{display:block;opacity:.86;font-weight:700;line-height:1.25;margin-top:2px}

    details{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:10px 12px;
    }
    details summary{
      cursor:pointer;
      font-weight:900;
      list-style:none;
    }
    details summary::-webkit-details-marker{display:none}
    pre{
      margin:10px 0 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      opacity:.9;
    }

    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:50;
      padding:10px 12px max(10px, env(safe-area-inset-bottom));
      background:rgba(0,0,0,.76);
      backdrop-filter:blur(12px);
      border-top:1px solid rgba(255,255,255,.14);
    }
    .bottomBar .inner{
      width:var(--w);
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .bottomBar .inner .btn{box-shadow:var(--shadow2)}
    .bottomBar .inner .btn.primary{flex:1 1 260px}
    @media (max-width:760px){
      .choiceRow{grid-template-columns:1fr}
      .bottomBar .inner{gap:8px}
      .bottomBar .inner .btn{flex:1 1 46%}
      .bottomBar .inner .btn.primary{flex:1 1 100%}
    }

    .disabled{
      opacity:.55;
      filter:saturate(.6);
      pointer-events:none;
    }
  </style>
</head>

<body>
  <header>
    <button class="btn" type="button" onclick="location.href='index.html'">Startseite</button>
    <h1>Dynamik</h1>
  </header>

  <main class="wrap">

    <section class="card">
      <h2>1. Aktivieren</h2>

      <div class="toggle" id="toggleWrap">
        <div>
          <div class="tTitle">Dynamische Verschlechterung in der Ablage</div>
          <div class="tSub">Wenn aktiv, werden Patientensichtungen innerhalb des Zeitfensters zufällig verschlechtert.</div>
        </div>
        <div class="switch" id="swEnabled" role="switch" aria-checked="false" tabindex="0"></div>
      </div>

      <div class="line"></div>

      <div class="status" id="statusBox">
        <div class="dot" id="statusDot"></div>
        <div class="msg" id="statusMsg">Dynamik ist aus.<small>Aktiviere oben die Dynamik, um Einstellungen vorzunehmen.</small></div>
      </div>
    </section>

    <section class="card" id="cfgCard">
      <h2>2. Schnellprofil</h2>
      <div class="muted">Wähle ein Preset. Du kannst danach alles fein einstellen.</div>

      <div class="presetRow" style="margin-top:10px;">
        <button class="presetBtn" id="presetLight" type="button">Leicht<small>Wenig Verschlechterungen, viel Zeit</small></button>
        <button class="presetBtn" id="presetMedium" type="button">Mittel<small>Realistisch für Ausbildung</small></button>
        <button class="presetBtn" id="presetHard" type="button">Hart<small>Mehr Druck im Szenario</small></button>
      </div>

      <div class="line"></div>

      <h2 style="margin-top:0;">3. Zeitfenster</h2>
      <div class="grid2">
        <div class="rangeBox">
          <div class="rangeLabel">
            <span>Start ab Minute</span>
            <span class="kv"><span id="lblStart">3</span> min</span>
          </div>
          <input type="range" id="rngStart" min="0" max="60" step="1" value="3" />
          <div class="muted" style="font-size:12px;margin-top:6px;">Ab dieser Minute können Verschlechterungen beginnen.</div>
        </div>

        <div class="rangeBox">
          <div class="rangeLabel">
            <span>Ende bis Minute</span>
            <span class="kv"><span id="lblEnd">20</span> min</span>
          </div>
          <input type="range" id="rngEnd" min="1" max="120" step="1" value="20" />
          <div class="muted" style="font-size:12px;margin-top:6px;">Bis zu dieser Minute werden Events verteilt.</div>
        </div>
      </div>

      <div class="line"></div>

      <h2 style="margin-top:0;">4. Intensität</h2>
      <div class="choiceRow">
        <div class="choice active" id="chPercent" role="button" tabindex="0">
          <strong>Prozent</strong>
          <small>Passt sich automatisch an die spätere Ablage an.</small>
        </div>
        <div class="choice" id="chCount" role="button" tabindex="0">
          <strong>Anzahl</strong>
          <small>Feste Anzahl Patienten verschlechtert sich.</small>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="rangeBox" id="boxPercent">
          <div class="rangeLabel">
            <span>Anteil der offenen Patienten</span>
            <span class="kv"><span id="lblPercent">30</span> Prozent</span>
          </div>
          <input type="range" id="rngPercent" min="0" max="100" step="5" value="30" />
          <div class="muted" style="font-size:12px;margin-top:6px;">Beispiel. 30 Prozent der offenen Patienten werden eingeplant.</div>
        </div>

        <div class="stepper disabled" id="boxCount">
          <button type="button" id="btnCountMinus">−</button>
          <div class="val" id="lblCount">3</div>
          <button type="button" id="btnCountPlus">+</button>
          <div class="hint">Anzahl Events</div>
        </div>
      </div>

      <div class="line"></div>

      <h2 style="margin-top:0;">5. Auswahllogik</h2>
      <div class="grid2">
        <div class="toggle">
          <div>
            <div class="tTitle">Proportional zur Ablage</div>
            <div class="tSub">Wenn in der Ablage überwiegend SK3 sind, werden auch überwiegend SK3 verschlechtert.</div>
          </div>
          <div class="switch on" id="swProportional" role="switch" aria-checked="true" tabindex="0"></div>
        </div>

        <div class="toggle">
          <div>
            <div class="tTitle">Nur eine Stufe schlechter</div>
            <div class="tSub">SK3 wird SK2, SK2 wird SK1. SK1 wird nicht automatisch TOT.</div>
          </div>
          <div class="switch on" id="swLowerOnly" role="switch" aria-checked="true" tabindex="0"></div>
        </div>
      </div>

      <div class="line"></div>

      <h2 style="margin-top:0;">6. SK1 zu TOT</h2>
      <div class="muted">Optional. Nur aktivieren, wenn du es wirklich willst.</div>

      <div class="grid2" style="margin-top:10px;">
        <div class="toggle">
          <div>
            <div class="tTitle">TOT zulassen</div>
            <div class="tSub">SK1 kann zu TOT werden. Sichtbar steht TOT, intern ist es schwarz.</div>
          </div>
          <div class="switch" id="swTot" role="switch" aria-checked="false" tabindex="0"></div>
        </div>

        <div class="stepper disabled" id="boxMaxTot">
          <button type="button" id="btnTotMinus">−</button>
          <div class="val" id="lblTotMax">3</div>
          <button type="button" id="btnTotPlus">+</button>
          <div class="hint">Max TOT</div>
        </div>

        <div class="rangeBox disabled" id="boxTotMin">
          <div class="rangeLabel">
            <span>TOT frühestens ab Minute</span>
            <span class="kv"><span id="lblTotMin">6</span> min</span>
          </div>
          <input type="range" id="rngTotMin" min="0" max="60" step="1" value="6" />
          <div class="muted" style="font-size:12px;margin-top:6px;">Empfehlung. 6 bis 12 Minuten.</div>
        </div>

        <div class="rangeBox disabled" id="boxTotShare">
          <div class="rangeLabel">
            <span>Anteil TOT innerhalb SK1 Events</span>
            <span class="kv"><span id="lblTotShare">40</span> Prozent</span>
          </div>
          <input type="range" id="rngTotShare" min="0" max="100" step="10" value="40" />
          <div class="muted" style="font-size:12px;margin-top:6px;">Beispiel. 40 Prozent der ausgewählten SK1 Events werden TOT.</div>
        </div>
      </div>

      <div class="line"></div>

      <h2 style="margin-top:0;">7. Vorschau</h2>
      <div class="status">
        <div class="dot" id="prevDot"></div>
        <div class="msg" id="prevMsg">Noch keine Ablage geladen.<small>Wenn offene Patienten vorhanden sind, wird hier die geschätzte Anzahl Events angezeigt.</small></div>
      </div>

      <details style="margin-top:12px;">
        <summary>Debug anzeigen</summary>
        <pre id="debugOut"></pre>
      </details>
    </section>
  </main>

  <div class="bottomBar" role="region" aria-label="Aktionen">
    <div class="inner">
      <button class="btn danger" id="btnResetPlan" type="button">Plan zurücksetzen</button>
      <button class="btn primary" id="btnSave" type="button">Speichern</button>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const LS_CFG  = 'ablage.dynamik.v1';
  const LS_PLAN = 'ablage.dynamik.plan.v1';
  const LS_DONE = 'ablage.done.v1';
  const LS_SMAP = 'sichtungMap';

  const el = (id)=>document.getElementById(id);

  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch(e){ return fallback; }
  }
  function load(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return safeParse(raw, fallback);
    }catch(e){
      return fallback;
    }
  }
  function save(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
  }

  function clamp(n, a, b){
    n = Number(n);
    if(!Number.isFinite(n)) n = a;
    return Math.max(a, Math.min(b, n));
  }

  function normCat(x){
    return String(x||'').toLowerCase().replace('grün','gruen').trim();
  }

  function setSwitch(sw, on){
    sw.classList.toggle('on', !!on);
    sw.setAttribute('aria-checked', on ? 'true' : 'false');
  }
  function getSwitch(sw){
    return sw.classList.contains('on');
  }

  function setChoice(which){
    const isPercent = which === 'percent';
    el('chPercent').classList.toggle('active', isPercent);
    el('chCount').classList.toggle('active', !isPercent);

    el('boxPercent').classList.toggle('disabled', !isPercent);
    el('boxCount').classList.toggle('disabled', isPercent);

    state.intensityMode = isPercent ? 'percent' : 'count';
    updatePreview();
    updateDebug();
  }

  function setPreset(name){
    state.preset = name;

    el('presetLight').classList.toggle('active', name === 'light');
    el('presetMedium').classList.toggle('active', name === 'medium');
    el('presetHard').classList.toggle('active', name === 'hard');

    if(name === 'light'){
      state.startMin = 5;
      state.endMin = 25;
      state.percent = 10;
      state.count = 2;
      state.totEnabled = false;
      state.maxTot = 1;
      state.totMin = 10;
      state.totShare = 20;
    } else if(name === 'medium'){
      state.startMin = 3;
      state.endMin = 20;
      state.percent = 30;
      state.count = 3;
      state.totEnabled = false;
      state.maxTot = 2;
      state.totMin = 8;
      state.totShare = 30;
    } else if(name === 'hard'){
      state.startMin = 2;
      state.endMin = 10;
      state.percent = 60;
      state.count = 6;
      state.totEnabled = true;
      state.maxTot = 4;
      state.totMin = 6;
      state.totShare = 50;
    }

    syncUI();
  }

  function getOpenCounts(){
    const doneList = load(LS_DONE, []);
    const done = new Set(Array.isArray(doneList) ? doneList : []);
    const sMap = load(LS_SMAP, {});
    const ids = Object.keys(sMap || {}).filter(id => /^patient\d+$/i.test(id) && !done.has(id));

    let gruen=0, gelb=0, rot=0, schwarz=0;
    for(const id of ids){
      const c = normCat(sMap[id]);
      if(c === 'gruen') gruen++;
      else if(c === 'gelb') gelb++;
      else if(c === 'rot') rot++;
      else if(c === 'schwarz') schwarz++;
    }
    return { total: ids.length, gruen, gelb, rot, schwarz };
  }

  function estimateEvents(counts){
    const total = counts.total;
    if(total <= 0) return { total:0, from:{gruen:0,gelb:0,rot:0}, tot:0 };

    let n = 0;
    if(state.intensityMode === 'percent'){
      n = Math.round(total * (state.percent/100));
    } else {
      n = state.count;
    }
    n = clamp(n, 0, total);

    let g=0,y=0,r=0;
    if(getSwitch(el('swProportional'))){
      const sum = (counts.gruen + counts.gelb + counts.rot) || total;
      g = Math.round(n * (counts.gruen / sum));
      y = Math.round(n * (counts.gelb / sum));
      r = n - g - y;

      g = clamp(g, 0, counts.gruen);
      y = clamp(y, 0, counts.gelb);
      r = clamp(r, 0, counts.rot);

      let left = n - (g+y+r);
      if(left > 0){
        let capG = counts.gruen - g;
        let capY = counts.gelb - y;
        let capR = counts.rot - r;
        while(left > 0 && (capG+capY+capR) > 0){
          if(capG > 0){ g++; capG--; left--; continue; }
          if(capY > 0){ y++; capY--; left--; continue; }
          if(capR > 0){ r++; capR--; left--; continue; }
          break;
        }
      }
    } else {
      g = clamp(n, 0, counts.gruen);
      let left = n - g;
      y = clamp(left, 0, counts.gelb);
      left -= y;
      r = clamp(left, 0, counts.rot);
    }

    let tot = 0;
    if(state.totEnabled){
      const totPossible = Math.min(state.maxTot, r);
      tot = Math.round(r * (state.totShare/100));
      tot = clamp(tot, 0, totPossible);
    }

    return { total:n, from:{gruen:g,gelb:y,rot:r}, tot:tot };
  }

  function updateStatus(){
    const enabled = state.enabled;

    setSwitch(el('swEnabled'), enabled);
    el('cfgCard').classList.toggle('disabled', !enabled);

    if(!enabled){
      el('statusDot').className = 'dot';
      el('statusMsg').innerHTML = 'Dynamik ist aus.<small>Aktiviere oben die Dynamik, um Einstellungen vorzunehmen.</small>';
      return;
    }

    el('statusDot').className = 'dot ok';
    el('statusMsg').innerHTML = 'Dynamik ist aktiv.<small>Einstellungen speichern und dann im Einsatz wie gewohnt arbeiten.</small>';
  }

  function updateTotUI(){
    const on = state.totEnabled;
    setSwitch(el('swTot'), on);
    el('boxMaxTot').classList.toggle('disabled', !on);
    el('boxTotMin').classList.toggle('disabled', !on);
    el('boxTotShare').classList.toggle('disabled', !on);
  }

  function updateTimeUI(){
    el('rngStart').value = String(state.startMin);
    el('rngEnd').value = String(state.endMin);
    el('lblStart').textContent = String(state.startMin);
    el('lblEnd').textContent = String(state.endMin);
  }

  function updateIntensityUI(){
    el('rngPercent').value = String(state.percent);
    el('lblPercent').textContent = String(state.percent);
    el('lblCount').textContent = String(state.count);
  }

  function updatePreview(){
    const counts = getOpenCounts();
    const est = estimateEvents(counts);

    if(!state.enabled){
      el('prevDot').className = 'dot';
      el('prevMsg').innerHTML = 'Dynamik ist aus.<small>Aktiviere oben die Dynamik.</small>';
      return;
    }

    if(counts.total <= 0){
      el('prevDot').className = 'dot bad';
      el('prevMsg').innerHTML = 'Keine offenen Patienten.<small>Es werden erst Events geplant, wenn Patienten offen sind.</small>';
      return;
    }

    if(est.total <= 0){
      el('prevDot').className = 'dot warn';
      el('prevMsg').innerHTML = 'Events. 0.<small>Erhöhe Prozent oder Anzahl.</small>';
      return;
    }

    const parts = [];
    if(est.from.gruen) parts.push('SK3 ' + est.from.gruen);
    if(est.from.gelb) parts.push('SK2 ' + est.from.gelb);
    if(est.from.rot) parts.push('SK1 ' + est.from.rot);
    const base = parts.length ? parts.join(', ') : 'Keine Auswahl möglich';

    let extra = '';
    if(state.totEnabled && est.tot){
      extra = ' plus TOT ' + est.tot;
    }

    el('prevDot').className = 'dot ok';
    el('prevMsg').innerHTML = 'Geplant. ' + est.total + ' Events.<small>Verteilung. ' + base + extra + '.</small>';
  }

  function updateDebug(){
    const counts = getOpenCounts();
    const est = estimateEvents(counts);

    const cfg = toConfig(counts);
    const lines = [];
    lines.push('enabled: ' + cfg.enabled);
    lines.push('mode: ' + cfg.mode);
    lines.push('window: ' + cfg.random.minMin + ' bis ' + cfg.random.maxMin + ' Minuten');
    lines.push('intensityMode: ' + state.intensityMode);
    lines.push('percent: ' + state.percent);
    lines.push('count: ' + state.count);
    lines.push('open: total ' + counts.total + ', sk3 ' + counts.gruen + ', sk2 ' + counts.gelb + ', sk1 ' + counts.rot);
    lines.push('estimate: events ' + est.total + ', sk3 ' + est.from.gruen + ', sk2 ' + est.from.gelb + ', sk1 ' + est.from.rot + ', tot ' + est.tot);
    lines.push('savedCfg: ' + JSON.stringify(cfg, null, 2));
    el('debugOut').textContent = lines.join('\n');
  }

  function syncUI(){
    updateStatus();
    updateTimeUI();
    updateIntensityUI();
    updateTotUI();

    if(state.intensityMode === 'percent') setChoice('percent');
    else setChoice('count');

    el('lblTotMax').textContent = String(state.maxTot);
    el('lblTotMin').textContent = String(state.totMin);
    el('rngTotMin').value = String(state.totMin);
    el('lblTotShare').textContent = String(state.totShare);
    el('rngTotShare').value = String(state.totShare);

    setSwitch(el('swProportional'), state.proportional);
    setSwitch(el('swLowerOnly'), state.lowerOnly);

    updatePreview();
    updateDebug();
  }

  function toConfig(counts){
    const est = estimateEvents(counts || getOpenCounts());
    const cfg = {
      enabled: !!state.enabled,
      mode: 'random',
      basis: 'patient',
      random: {
        minMin: clamp(state.startMin, 0, 999),
        maxMin: clamp(state.endMin, 1, 999),
        minGapSec: 10,
        toLowerOnly: !!state.lowerOnly,
        proportional: !!state.proportional,
        intensityMode: state.intensityMode,
        percent: clamp(state.percent, 0, 100),
        count: clamp(state.count, 0, 999),
        countEstimate: est.total,
        allowTot: !!state.totEnabled,
        maxTot: clamp(state.maxTot, 0, 999),
        totMin: clamp(state.totMin, 0, 999),
        totShare: clamp(state.totShare, 0, 100)
      }
    };
    return cfg;
  }

  function saveCfg(){
    const counts = getOpenCounts();
    const cfg = toConfig(counts);
    save(LS_CFG, cfg);
    updateStatus();
    updatePreview();
    updateDebug();
  }

  function resetPlan(){
    try{ localStorage.removeItem(LS_PLAN); }catch(e){}
    updatePreview();
    updateDebug();
  }

  function toggleSwitch(sw, stateKey){
    const on = !getSwitch(sw);
    setSwitch(sw, on);
    state[stateKey] = on;
    if(stateKey === 'enabled') updateStatus();
    if(stateKey === 'totEnabled') updateTotUI();
    updatePreview();
    updateDebug();
  }

  const state = {
    enabled: false,
    preset: 'medium',
    startMin: 3,
    endMin: 20,
    intensityMode: 'percent',
    percent: 30,
    count: 3,
    proportional: true,
    lowerOnly: true,
    totEnabled: false,
    maxTot: 3,
    totMin: 6,
    totShare: 40
  };

  function loadCfg(){
    const cfg = load(LS_CFG, null);
    if(!cfg) return;

    state.enabled = !!cfg.enabled;

    const rnd = cfg.random || {};
    state.startMin = clamp(rnd.minMin != null ? rnd.minMin : state.startMin, 0, 60);
    state.endMin   = clamp(rnd.maxMin != null ? rnd.maxMin : state.endMin, 1, 120);
    if(state.endMin < state.startMin) state.endMin = state.startMin + 1;

    state.lowerOnly = (rnd.toLowerOnly != null) ? !!rnd.toLowerOnly : state.lowerOnly;
    state.proportional = (rnd.proportional != null) ? !!rnd.proportional : state.proportional;

    state.intensityMode = (rnd.intensityMode === 'count') ? 'count' : 'percent';
    state.percent = clamp(rnd.percent != null ? rnd.percent : state.percent, 0, 100);
    state.count = clamp(rnd.count != null ? rnd.count : state.count, 0, 999);

    state.totEnabled = !!rnd.allowTot;
    state.maxTot = clamp(rnd.maxTot != null ? rnd.maxTot : state.maxTot, 0, 999);
    state.totMin = clamp(rnd.totMin != null ? rnd.totMin : state.totMin, 0, 60);
    state.totShare = clamp(rnd.totShare != null ? rnd.totShare : state.totShare, 0, 100);
  }

  function bind(){
    const swEnabled = el('swEnabled');
    swEnabled.addEventListener('click', ()=>toggleSwitch(swEnabled,'enabled'));
    swEnabled.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSwitch(swEnabled,'enabled'); }});

    const swProp = el('swProportional');
    swProp.addEventListener('click', ()=>toggleSwitch(swProp,'proportional'));
    swProp.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSwitch(swProp,'proportional'); }});

    const swLower = el('swLowerOnly');
    swLower.addEventListener('click', ()=>toggleSwitch(swLower,'lowerOnly'));
    swLower.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSwitch(swLower,'lowerOnly'); }});

    const swTot = el('swTot');
    swTot.addEventListener('click', ()=>toggleSwitch(swTot,'totEnabled'));
    swTot.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSwitch(swTot,'totEnabled'); }});

    el('presetLight').addEventListener('click', ()=>setPreset('light'));
    el('presetMedium').addEventListener('click', ()=>setPreset('medium'));
    el('presetHard').addEventListener('click', ()=>setPreset('hard'));

    el('rngStart').addEventListener('input', ()=>{
      state.startMin = clamp(el('rngStart').value, 0, 60);
      if(state.endMin < state.startMin + 1){
        state.endMin = state.startMin + 1;
      }
      syncUI();
    });
    el('rngEnd').addEventListener('input', ()=>{
      state.endMin = clamp(el('rngEnd').value, 1, 120);
      if(state.endMin < state.startMin + 1){
        state.startMin = Math.max(0, state.endMin - 1);
      }
      syncUI();
    });

    el('rngPercent').addEventListener('input', ()=>{
      state.percent = clamp(el('rngPercent').value, 0, 100);
      updateIntensityUI();
      updatePreview();
      updateDebug();
    });

    el('btnCountMinus').addEventListener('click', ()=>{
      state.count = clamp(state.count - 1, 0, 999);
      updateIntensityUI();
      updatePreview();
      updateDebug();
    });
    el('btnCountPlus').addEventListener('click', ()=>{
      state.count = clamp(state.count + 1, 0, 999);
      updateIntensityUI();
      updatePreview();
      updateDebug();
    });

    el('chPercent').addEventListener('click', ()=>setChoice('percent'));
    el('chCount').addEventListener('click', ()=>setChoice('count'));
    el('chPercent').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setChoice('percent'); }});
    el('chCount').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setChoice('count'); }});

    el('btnTotMinus').addEventListener('click', ()=>{
      state.maxTot = clamp(state.maxTot - 1, 0, 999);
      el('lblTotMax').textContent = String(state.maxTot);
      updatePreview();
      updateDebug();
    });
    el('btnTotPlus').addEventListener('click', ()=>{
      state.maxTot = clamp(state.maxTot + 1, 0, 999);
      el('lblTotMax').textContent = String(state.maxTot);
      updatePreview();
      updateDebug();
    });

    el('rngTotMin').addEventListener('input', ()=>{
      state.totMin = clamp(el('rngTotMin').value, 0, 60);
      el('lblTotMin').textContent = String(state.totMin);
      updatePreview();
      updateDebug();
    });

    el('rngTotShare').addEventListener('input', ()=>{
      state.totShare = clamp(el('rngTotShare').value, 0, 100);
      el('lblTotShare').textContent = String(state.totShare);
      updatePreview();
      updateDebug();
    });

    el('btnSave').addEventListener('click', saveCfg);
    el('btnResetPlan').addEventListener('click', resetPlan);
  }

  function tick(){
    updatePreview();
    updateDebug();
  }

  loadCfg();
  setPreset('medium');
  bind();
  syncUI();
  setInterval(tick, 1200);

})();
</script>

</body>
</html>
