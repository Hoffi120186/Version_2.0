<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Patienten Übersicht</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <style>
    :root{
      --text:#e5e7eb;
      --muted:#cbd5e1;
      --bg1:#0b0f1a;
      --shadow:0 14px 36px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(37,99,235,.25), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(239,68,68,.22), transparent 60%),
                  radial-gradient(900px 700px at 70% 85%, rgba(34,197,94,.18), transparent 60%),
                  var(--bg1);
    }

    /* V7 Overrides: klare Balken, weniger verschachtelt */
    .stickyStack{ position:sticky; top:0; z-index:40; padding:10px 10px 0; backdrop-filter: blur(10px); }
    .topbar{ width:min(980px, 96vw); margin:0 auto; display:grid; grid-template-columns: 1fr 1.2fr auto; gap:10px; align-items:center; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18); border-radius:18px; padding:12px; }
    .tbChips{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .chip{ padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.10); font-weight:900; }

    .stack{ width:min(980px, 96vw); margin:10px auto 12px; display:flex; flex-direction:column; gap:10px; }
    .stackItem{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); border-radius:18px; overflow:hidden; box-shadow:0 14px 30px rgba(0,0,0,.35); }
    .stackSum{ list-style:none; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px; cursor:pointer; }
    .stackSum::-webkit-details-marker{ display:none; }
    .sumTitle{ font-weight:1000; font-size:18px; }
    .sumSub{ opacity:.85; font-weight:800; font-size:13px; margin-top:2px; }
    .sumRight{ display:flex; align-items:center; gap:10px; }
    .pill{ padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.10); font-weight:1000; }
    .pill.danger{ background:rgba(220,38,38,.18); border-color:rgba(220,38,38,.35); }
    .chev{ opacity:.85; font-size:18px; transform: translateY(-1px); }
    .stackBody{ padding:0 14px 14px; border-top:1px solid rgba(255,255,255,.10); }

    .panel{ margin-top:12px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.22); }
    .panel.collapsed{ display:none; }

    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{ padding:14px 14px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.10); color:#fff; font-weight:1000; }
    .btn.primary{ background:linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1)); border:none; }
    .btn.danger{ background:linear-gradient(180deg, rgba(239,68,68,1), rgba(153,27,27,1)); border:none; }
    .tbBtn{ padding:14px 14px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.10); color:#fff; font-weight:1000; }
    .tbBtn.primary{ background:linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1)); border:none; }

    .fieldTitle{ font-weight:1000; margin-bottom:10px; }
    .chipsRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .qbtn{ padding:12px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.10); color:#fff; font-weight:1000; min-width:64px; }
    .qbtn.active{ background:rgba(37,99,235,.35); border-color:rgba(37,99,235,.55); }

    .select{ width:100%; padding:12px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#fff; font-weight:1000; }
    .hintLine{ margin-top:10px; opacity:.85; font-size:13px; font-weight:800; }

    .toggleRow{ display:flex; align-items:center; gap:10px; font-weight:1000; padding-top:10px; }
    .toggleRow input{ width:20px; height:20px; }

    .ruleBox{ margin-top:10px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.22); }
    .ruleTitle{ font-weight:1000; margin-bottom:10px; }
    .ruleTitle.sk3{ color:#86efac; }
    .ruleTitle.sk2{ color:#fde047; }
    .ruleTitle.sk1{ color:#fca5a5; }
    .ruleRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .ruleLabel{ font-weight:1000; opacity:.9; }
    .ruleUnit{ opacity:.85; font-weight:1000; }
    .minSel,.toSel{ -webkit-appearance:none; appearance:none; padding:12px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.28); color:#fff; font-weight:1000; }
    .minSel{ min-width:130px; }
    .toSel{ min-width:170px; }
    .toSel.to-rot{ background:rgba(229,57,53,.85); border-color:rgba(229,57,53,.85); }
    .toSel.to-gelb{ background:rgba(243,252,2,.92); border-color:rgba(243,252,2,.92); color:#111; }
    .toSel.to-gruen{ background:rgba(46,125,50,.85); border-color:rgba(46,125,50,.85); }
    .toSel.to-schwarz{ background:rgba(17,17,17,.90); border-color:rgba(17,17,17,.90); }

    .countRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .countChip{ padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.10); font-weight:1000; }
    .countChip.rot{ background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35); }
    .countChip.gelb{ background:rgba(234,179,8,.16); border-color:rgba(234,179,8,.35); }
    .countChip.gruen{ background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.35); }
    .countChip.schwarz{ background:rgba(0,0,0,.30); border-color:rgba(255,255,255,.14); }

    #grid{ width:min(980px, 96vw); margin: 10px auto 24px; display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); padding: 0 10px; }

    @media (max-width:520px){
      .topbar{ grid-template-columns: 1fr 1fr; grid-auto-rows:auto; }
      .tbChips{ grid-column:1/3; justify-content:flex-start; }
      .row2{ grid-template-columns:1fr; }
      .minSel,.toSel{ width:100%; min-width:0; }
      .qbtn{ min-width:72px; flex:1; }
      #grid{ grid-template-columns: 1fr; padding: 0 10px; }
    }
  </style>
</head>

<body>

<div class="stickyStack">
  <div class="topbar">
    <button class="tbBtn" onclick="history.back()">Zurück</button>
    <button class="tbBtn primary" onclick="location.href='ablage1.html'">Direkt zur Pat. Ablage</button>

    <div class="tbChips">
      <span class="chip" id="loadedChip">Geladen 0</span>
      <span class="chip" id="selectedChip">Ausgewählt 0</span>
    </div>
  </div>

  <div class="stack">

    <details class="stackItem" id="secTraining" open>
      <summary class="stackSum">
        <div class="sumLeft">
          <div class="sumTitle">Patientenablage Training</div>
          <div class="sumSub">Einstellungen</div>
        </div>
        <div class="sumRight">
          <span class="pill" id="trainingState">Aus</span>
          <span class="chev">⌄</span>
        </div>
      </summary>

      <div class="stackBody">
        <div class="row2">
          <button class="btn primary" id="trainingBtn" type="button">Aktivieren</button>
          <button class="btn" id="btnKarussell" type="button">Karussell</button>
        </div>

        <div id="trainingPanel" class="panel collapsed">
          <div class="fieldTitle">Schnellauswahl</div>
          <div class="chipsRow">
            <button class="qbtn" data-n="10" type="button">10</button>
            <button class="qbtn" data-n="15" type="button">15</button>
            <button class="qbtn" data-n="20" type="button">20</button>
            <button class="qbtn" data-n="25" type="button">25</button>
            <button class="qbtn" data-n="30" type="button">30</button>
            <button class="qbtn" data-n="35" type="button">35</button>
            <button class="qbtn" data-n="40" type="button">40</button>
          </div>

          <div class="row2" style="margin-top:10px;">
            <select id="mixSel" class="select">
              <option value="mix203050">Mix 20, 30, 50</option>
              <option value="mix251050">Mix 25, 10, 50</option>
              <option value="mix301040">Mix 30, 10, 40</option>
            </select>
            <button class="btn" id="btnNeuAuswahl" type="button">Neu auswählen</button>
          </div>
        </div>

        <div class="hintLine">
          Wenn Training aktiv ist, erscheint hier die Schnellauswahl. Die Patientenkarten bleiben darunter sauber untereinander.
        </div>
      </div>
    </details>

    <details class="stackItem" id="secDet">
      <summary class="stackSum">
        <div class="sumLeft">
          <div class="sumTitle">Patientenverschlechterung im Training</div>
          <div class="sumSub" id="detSummaryLine">Regeln festlegen</div>
        </div>
        <div class="sumRight">
          <span class="pill danger" id="detStateMini"><span id="detStateMiniText">Aus</span></span>
          <span class="chev">⌄</span>
        </div>
      </summary>

      <div class="stackBody">
        <label class="toggleRow">
          <input id="detEnabled" type="checkbox">
          <span>Aktivieren</span>
        </label>

        <div class="ruleBox">
          <div class="ruleTitle sk3">SK3 GRÜN</div>
          <div class="ruleRow">
            <span class="ruleLabel">Nach</span>
            <select id="detGruenMin" class="minSel"></select>
            <span class="ruleUnit">Min</span>
            <span class="ruleLabel">zu</span>
            <select id="detGruenTo" class="toSel">
              <option value="gelb">GELB</option>
              <option value="rot">ROT</option>
              <option value="schwarz">SCHWARZ</option>
            </select>
          </div>
        </div>

        <div class="ruleBox">
          <div class="ruleTitle sk2">SK2 GELB</div>
          <div class="ruleRow">
            <span class="ruleLabel">Nach</span>
            <select id="detGelbMin" class="minSel"></select>
            <span class="ruleUnit">Min</span>
            <span class="ruleLabel">zu</span>
            <select id="detGelbTo" class="toSel">
              <option value="rot">ROT</option>
              <option value="schwarz">SCHWARZ</option>
            </select>
          </div>
        </div>

        <div class="ruleBox">
          <div class="ruleTitle sk1">SK1 ROT</div>
          <div class="ruleRow">
            <span class="ruleLabel">Nach</span>
            <select id="detRotMin" class="minSel"></select>
            <span class="ruleUnit">Min</span>
            <span class="ruleLabel">zu</span>
            <select id="detRotTo" class="toSel">
              <option value="schwarz">SCHWARZ</option>
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <button class="btn primary" type="button" id="btnDetSave">Speichern</button>
          <button class="btn" type="button" id="btnDetReset">Zurücksetzen</button>
        </div>

        <div class="hintLine">
          Diese Regeln gelten für die Patientenablage. Schwarz ist Endzustand.
        </div>
      </div>
    </details>

    <details class="stackItem" id="secSel">
      <summary class="stackSum">
        <div class="sumLeft">
          <div class="sumTitle">Übersicht Auswahl</div>
          <div class="sumSub" id="selCountText">0 ausgewählt</div>
        </div>
        <div class="sumRight">
          <span class="chev">⌄</span>
        </div>
      </summary>

      <div class="stackBody">
        <div class="countRow">
          <span class="countChip rot" id="countRot">Auswahl Rot 0</span>
          <span class="countChip gelb" id="countGelb">Gelb 0</span>
          <span class="countChip gruen" id="countGruen">Grün 0</span>
          <span class="countChip schwarz" id="countSchwarz">Schwarz 0</span>
        </div>

        <div class="row2">
          <button class="btn" id="btnSelectAll" type="button">Alle auswählen</button>
          <button class="btn" id="btnClearSel" type="button">Auswahl löschen</button>
        </div>

        <div class="row2">
          <button class="btn primary" id="btnToAblage" type="button">In Ablage übernehmen</button>
          <button class="btn danger" id="btnCancel" type="button">Abbrechen</button>
        </div>
      </div>
    </details>

  </div>
</div>

<div id="grid"></div>

<script>
/* V7: globale Verschlechterung Regeln, kompatibel zu ablage1_ui_v3 */
const LS_DET_GLOBAL = 'ablage.deterioration.global.v1';

function v7FillMinuteSelect(sel, max){
  if(!sel) return;
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'Minuten';
  sel.appendChild(opt0);
  for(let i=1;i<=max;i++){
    const o=document.createElement('option');
    o.value = String(i);
    o.textContent = i + ' Min';
    sel.appendChild(o);
  }
}

function v7ApplyToStyle(sel){
  if(!sel) return;
  sel.classList.remove('to-rot','to-gelb','to-gruen','to-schwarz');
  const v=(sel.value||'').toLowerCase();
  if(v==='rot') sel.classList.add('to-rot');
  if(v==='gelb') sel.classList.add('to-gelb');
  if(v==='gruen' || v==='grün') sel.classList.add('to-gruen');
  if(v==='schwarz') sel.classList.add('to-schwarz');
}

function v7ReadGlobal(){
  try{
    const raw=localStorage.getItem(LS_DET_GLOBAL);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function v7WriteGlobal(obj){
  localStorage.setItem(LS_DET_GLOBAL, JSON.stringify(obj));
}

function v7UpdateDetBadge(enabled){
  const pill=document.getElementById('detStateMini');
  const t=document.getElementById('detStateMiniText');
  if(!pill || !t) return;
  if(enabled){
    t.textContent='An';
    pill.classList.add('on');
    pill.classList.remove('danger');
  }else{
    t.textContent='Aus';
    pill.classList.remove('on');
    pill.classList.add('danger');
  }
}

function v7LoadDetUI(){
  const data=v7ReadGlobal() || {enabled:false, steps:{gruen:{afterMin:10,to:'gelb'}, gelb:{afterMin:5,to:'rot'}, rot:{afterMin:8,to:'schwarz'}}};
  document.getElementById('detEnabled').checked = !!data.enabled;

  const g=data.steps?.gruen || {};
  const y=data.steps?.gelb || {};
  const r=data.steps?.rot || {};

  document.getElementById('detGruenMin').value = g.afterMin ? String(g.afterMin) : '';
  document.getElementById('detGelbMin').value = y.afterMin ? String(y.afterMin) : '';
  document.getElementById('detRotMin').value = r.afterMin ? String(r.afterMin) : '';

  document.getElementById('detGruenTo').value = (g.to||'gelb');
  document.getElementById('detGelbTo').value = (y.to||'rot');
  document.getElementById('detRotTo').value = (r.to||'schwarz');

  v7ApplyToStyle(document.getElementById('detGruenTo'));
  v7ApplyToStyle(document.getElementById('detGelbTo'));
  v7ApplyToStyle(document.getElementById('detRotTo'));

  v7UpdateDetBadge(!!data.enabled);
}

function v7SaveDetUI(){
  const enabled = document.getElementById('detEnabled').checked;

  const gMin = parseInt(document.getElementById('detGruenMin').value||'10',10);
  const yMin = parseInt(document.getElementById('detGelbMin').value||'5',10);
  const rMin = parseInt(document.getElementById('detRotMin').value||'8',10);

  const data = {
    enabled: !!enabled,
    steps:{
      gruen:{ afterMin: isFinite(gMin)?gMin:10, to: document.getElementById('detGruenTo').value },
      gelb:{ afterMin: isFinite(yMin)?yMin:5, to: document.getElementById('detGelbTo').value },
      rot:{ afterMin: isFinite(rMin)?rMin:8, to: document.getElementById('detRotTo').value }
    }
  };

  v7WriteGlobal(data);
  v7UpdateDetBadge(!!enabled);
  const line=document.getElementById('detSummaryLine');
  if(line) line.textContent = enabled ? 'Aktiv' : 'Regeln festlegen';
}

function v7ResetDetUI(){
  localStorage.removeItem(LS_DET_GLOBAL);
  v7LoadDetUI();
}

window.addEventListener('DOMContentLoaded', ()=>{
  v7FillMinuteSelect(document.getElementById('detGruenMin'), 60);
  v7FillMinuteSelect(document.getElementById('detGelbMin'), 60);
  v7FillMinuteSelect(document.getElementById('detRotMin'), 60);

  ['detGruenTo','detGelbTo','detRotTo'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('change', ()=>v7ApplyToStyle(el));
  });

  const btnSave=document.getElementById('btnDetSave');
  if(btnSave) btnSave.addEventListener('click', v7SaveDetUI);

  const btnReset=document.getElementById('btnDetReset');
  if(btnReset) btnReset.addEventListener('click', v7ResetDetUI);

  const detEnabled=document.getElementById('detEnabled');
  if(detEnabled) detEnabled.addEventListener('change', ()=>v7UpdateDetBadge(detEnabled.checked));

  v7LoadDetUI();
});
</script>

<script src="/metrics.js" defer></script>
</body>
</html>
