<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Patienten Übersicht</title>

  <style>
    :root{
      --text:#e5e7eb;
      --muted:rgba(229,231,235,.82);
      --glass:rgba(255,255,255,.10);
      --glass2:rgba(255,255,255,.14);
      --border:rgba(255,255,255,.18);
      --shadow:0 16px 44px rgba(0,0,0,.55);
      --radius:18px;

      --blue1:#1976ff;
      --blue2:#0f4ed6;

      --rot:#e53935;
      --gelb:#f7d803;
      --gruen:#22c55e;
      --schwarz:#111111;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background-image:url("fotos/Patientenkarte.jpg");
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:12px;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      z-index:-1;
    }

    .page{
      width:min(980px, 96vw);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding-bottom:18px;
    }

    .card{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      overflow:hidden;
    }

    .header{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:12px;
      align-items:stretch;
    }
    .header .left,
    .header .right{
      display:grid;
      gap:10px;
      align-content:start;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.35);
      transition: transform .15s ease, filter .15s ease, background .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      background:linear-gradient(180deg, var(--blue1), var(--blue2));
      border:none;
    }
    .btn.danger{
      background:linear-gradient(180deg, #ff3b30, #b10d0a);
      border:none;
    }
    .pill{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      text-align:center;
      box-shadow:0 10px 20px rgba(0,0,0,.30);
    }

    .topRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .topRow .btn{ width:100%; }
    .statsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .section{
      padding:10px 12px 12px;
      display:grid;
      gap:10px;
    }

    details.accord{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
    }
    details.accord > summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      font-weight:1000;
      user-select:none;
    }
    details.accord > summary::-webkit-details-marker{ display:none; }

    .sum-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .sum-title{
      font-size:18px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sum-sub{
      font-size:13px;
      color:rgba(229,231,235,.78);
      font-weight:900;
    }
    .sum-right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .togglePill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:999px;
      font-weight:1000;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      min-width:84px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .togglePill.on{
      background:rgba(34,197,94,.22);
      border-color:rgba(34,197,94,.45);
      color:#bbf7d0;
    }
    .togglePill.off{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.18);
      color:rgba(229,231,235,.85);
    }

    .accordBody{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:grid;
      gap:12px;
    }

    .miniHint{
      color:rgba(229,231,235,.78);
      font-size:13px;
      font-weight:900;
      line-height:1.35;
    }

    .quickRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chipBtn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-width:64px;
      text-align:center;
    }
    .chipBtn.active{
      background:rgba(25,118,255,.25);
      border-color:rgba(25,118,255,.45);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    select, input{
      font:inherit;
      color:var(--text);
      background:rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    select{ cursor:pointer; }

    .selectMini{
      width:100%;
    }
    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .countGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width:520px){
      .countGrid{ grid-template-columns: repeat(2, 1fr); }
      .header{ grid-template-columns: 1fr; }
      .statsRow{ grid-template-columns: 1fr 1fr; }
      .btnRow{ grid-template-columns: 1fr 1fr; }
      .row2{ grid-template-columns: 1fr; }
    }

    .countsPill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      font-weight:1000;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      box-shadow:0 0 0 2px rgba(255,255,255,.08) inset;
      flex:0 0 auto;
    }
    .dot.rot{ background:var(--rot); }
    .dot.gelb{ background:var(--gelb); }
    .dot.gruen{ background:var(--gruen); }
    .dot.schwarz{ background:var(--schwarz); }

    .list{
      display:grid;
      gap:12px;
      padding:12px;
    }

    .pat{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      box-shadow:0 16px 42px rgba(0,0,0,.45);
      position:relative;
    }
    .pat::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:10px;
      background:rgba(255,255,255,.18);
    }
    .pat.sk-rot::before{ background:rgba(229,57,53,.95); }
    .pat.sk-gelb::before{ background:rgba(247,216,3,.95); }
    .pat.sk-gruen::before{ background:rgba(34,197,94,.95); }
    .pat.sk-schwarz::before{ background:rgba(17,17,17,.95); }

    .patHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 8px 18px;
    }
    .patTitle{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .patTitle .name{
      font-size:28px;
      font-weight:1100;
      line-height:1.05;
      letter-spacing:.2px;
      text-shadow:0 2px 10px rgba(0,0,0,.55);
    }
    .badge{
      align-self:flex-start;
      padding:8px 12px;
      border-radius:999px;
      font-weight:1100;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      box-shadow:0 12px 24px rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .badge.rot{ background:rgba(229,57,53,.18); border-color:rgba(229,57,53,.35); }
    .badge.gelb{ background:rgba(247,216,3,.18); border-color:rgba(247,216,3,.35); color:#111; }
    .badge.gruen{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35); }
    .badge.schwarz{ background:rgba(17,17,17,.40); border-color:rgba(17,17,17,.70); }

    .patBody{
      padding:0 14px 12px 18px;
      display:grid;
      gap:8px;
    }
    .kv{
      display:grid;
      grid-template-columns: auto 1fr;
      gap:8px 12px;
      align-items:baseline;
      font-weight:900;
      color:rgba(229,231,235,.92);
    }
    .kv .k{ color:rgba(229,231,235,.78); font-weight:900; }
    .kv .v{ color:rgba(229,231,235,.96); font-weight:1000; }

    .patFoot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px 14px 18px;
      border-top:1px solid rgba(255,255,255,.10);
    }

    .ablageCheck{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      user-select:none;
    }
    .ablageCheck input{
      width:22px; height:22px;
      border-radius:6px;
      accent-color: #1976ff;
    }

    .previewBtn{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(34,197,94,.14);
      color:rgba(229,231,235,.95);
      font-weight:1000;
      box-shadow:0 12px 24px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .previewBtn:active{ transform: translateY(1px) scale(.99); }

    details.patOpt{
      margin:0 14px 14px 18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      overflow:hidden;
    }
    details.patOpt > summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      font-weight:1000;
      user-select:none;
    }
    details.patOpt > summary::-webkit-details-marker{ display:none; }

    .optBody{
      padding:12px 12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:grid;
      gap:10px;
    }

    .optLine{
      display:grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap:10px;
      align-items:center;
      font-weight:1000;
    }
    @media (max-width:520px){
      .optLine{ grid-template-columns: auto 1fr; }
    }
    .tag{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      font-weight:1100;
      text-align:center;
    }
    .toSel{
      width:100%;
      font-weight:1100;
      border-radius:14px;
      padding:10px 12px;
    }
    .toSel.to-rot{ background:rgba(229,57,53,.80); border-color:rgba(229,57,53,.80); }
    .toSel.to-gelb{ background:rgba(247,216,3,.92); border-color:rgba(247,216,3,.92); color:#111; }
    .toSel.to-gruen{ background:rgba(34,197,94,.78); border-color:rgba(34,197,94,.78); }
    .toSel.to-schwarz{ background:rgba(17,17,17,.88); border-color:rgba(17,17,17,.88); }

    .warn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      color:rgba(229,231,235,.84);
      font-size:13px;
      line-height:1.35;
    }

    .empty{
      padding:16px 12px 20px;
      text-align:center;
      color:rgba(229,231,235,.85);
      font-weight:900;
    }
  </style>

  <link rel="stylesheet" href="/css/app-flow.css?v=2">
</head>

<body>
  <div class="page">

    <div class="card header">
      <div class="left">
        <div class="topRow">
          <button class="btn" id="btnBack" type="button">Zurück</button>
          <button class="btn primary" id="btnAblage" type="button">Direkt zur Pat. Ablage</button>
        </div>
      </div>
      <div class="right">
        <div class="statsRow">
          <div class="pill" id="cntLoaded">Geladen 0</div>
          <div class="pill" id="cntSelected">Ausgewählt 0</div>
        </div>
      </div>
    </div>

    <div class="card section">
      <details class="accord" id="accTraining">
        <summary>
          <div class="sum-left">
            <div class="sum-title">Patientenablage Training</div>
            <div class="sum-sub">Einstellungen</div>
          </div>
          <div class="sum-right">
            <div class="togglePill off" id="trainingToggle" role="button" aria-pressed="false">Aus</div>
            <div style="opacity:.85;font-weight:1100">▼</div>
          </div>
        </summary>

        <div class="accordBody" id="trainingBody">
          <div class="miniHint">
            Schnell Auswahl wählt zufällig Patienten aus deiner Liste. Danach kannst du unten speichern, oder abbrechen.
          </div>

          <div class="quickRow" id="quickRow">
            <div class="chipBtn" data-q="10">10</div>
            <div class="chipBtn" data-q="15">15</div>
            <div class="chipBtn" data-q="20">20</div>
            <div class="chipBtn" data-q="25">25</div>
            <div class="chipBtn" data-q="30">30</div>
            <div class="chipBtn" data-q="35">35</div>
            <div class="chipBtn" data-q="40">40</div>
          </div>

          <div class="row2">
            <button class="btn" id="mixBtn" type="button">Mix</button>
            <select id="mixSelect" class="selectMini">
              <option value="20,30,50">Mix 20,30,50</option>
              <option value="25,25,50">Mix 25,25,50</option>
              <option value="33,33,34">Mix 33,33,34</option>
            </select>
          </div>

          <button class="btn" id="btnNewSelect" type="button">Neu auswählen</button>

          <div class="warn">
            Hinweis. Das Training schaltet nur die Auswahl und die Ablage Funktion frei. Patienten Regeln stellst du unter Szenario ein.
          </div>
        </div>
      </details>

      <details class="accord" id="accDeterioration">
        <summary>
          <div class="sum-left">
            <div class="sum-title">Patientenverschlechterung im Training</div>
            <div class="sum-sub">Regeln festlegen</div>
          </div>
          <div class="sum-right">
            <div class="togglePill off" id="detToggle" role="button" aria-pressed="false">Aus</div>
            <div style="opacity:.85;font-weight:1100">▼</div>
          </div>
        </summary>

        <div class="accordBody">
          <div class="miniHint">
            Diese Regeln stellst du unter Szenario ein. Hier wird nur der Status angezeigt.
          </div>
          <button class="btn" id="btnOpenScenario" type="button">Einstellungen öffnen</button>
        </div>
      </details>

      <details class="accord" id="accSelection">
        <summary>
          <div class="sum-left">
            <div class="sum-title">Übersicht Auswahl</div>
            <div class="sum-sub"><span id="selTotalTxt">0 ausgewählt</span></div>
          </div>
          <div class="sum-right">
            <div style="opacity:.85;font-weight:1100">▼</div>
          </div>
        </summary>

        <div class="accordBody">
          <div class="countGrid">
            <div class="countsPill"><span style="display:flex;align-items:center;gap:8px"><span class="dot rot"></span>Auswahl Rot</span><span id="selRot">0</span></div>
            <div class="countsPill"><span style="display:flex;align-items:center;gap:8px"><span class="dot gelb"></span>Gelb</span><span id="selGelb">0</span></div>
            <div class="countsPill"><span style="display:flex;align-items:center;gap:8px"><span class="dot gruen"></span>Grün</span><span id="selGruen">0</span></div>
            <div class="countsPill"><span style="display:flex;align-items:center;gap:8px"><span class="dot schwarz"></span>Schwarz</span><span id="selSchwarz">0</span></div>
          </div>

          <div class="btnRow">
            <button class="btn" id="bulkSelectAll" type="button">Alle auswählen</button>
            <button class="btn" id="bulkClear" type="button">Auswahl löschen</button>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="bulkToAblage" type="button">In Ablage übernehmen</button>
            <button class="btn danger" id="bulkCancel" type="button">Abbrechen</button>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <div class="list" id="grid">
        <div class="empty" id="emptyState">Lade Patienten</div>
      </div>
    </div>

  </div>

  <script>
    const LS_SELECTED_KEY = "ablage_selected_patients_v1";
    const LS_TRAINING_KEY = "training_ablage_enabled_v1";

    const elGrid = document.getElementById("grid");
    const elEmpty = document.getElementById("emptyState");

    const elCntLoaded = document.getElementById("cntLoaded");
    const elCntSelected = document.getElementById("cntSelected");

    const accTraining = document.getElementById("accTraining");
    const accDeterioration = document.getElementById("accDeterioration");
    const accSelection = document.getElementById("accSelection");

    const trainingToggle = document.getElementById("trainingToggle");
    const detToggle = document.getElementById("detToggle");

    const selTotalTxt = document.getElementById("selTotalTxt");
    const selRot = document.getElementById("selRot");
    const selGelb = document.getElementById("selGelb");
    const selGruen = document.getElementById("selGruen");
    const selSchwarz = document.getElementById("selSchwarz");

    const btnBack = document.getElementById("btnBack");
    const btnAblage = document.getElementById("btnAblage");
    const btnOpenScenario = document.getElementById("btnOpenScenario");

    const bulkSelectAll = document.getElementById("bulkSelectAll");
    const bulkClear = document.getElementById("bulkClear");
    const bulkToAblage = document.getElementById("bulkToAblage");
    const bulkCancel = document.getElementById("bulkCancel");

    const quickRow = document.getElementById("quickRow");
    const mixBtn = document.getElementById("mixBtn");
    const mixSelect = document.getElementById("mixSelect");
    const btnNewSelect = document.getElementById("btnNewSelect");

    let patients = [];
    let selected = new Set();
    let trainingEnabled = false;

    function setToggle(el, on){
      el.classList.toggle("on", !!on);
      el.classList.toggle("off", !on);
      el.textContent = on ? "An" : "Aus";
      el.setAttribute("aria-pressed", on ? "true" : "false");
    }

    function skClassFromValue(v){
      const s = String(v || "").toLowerCase();
      if(s.includes("rot") || s==="1" || s==="sk1") return "rot";
      if(s.includes("gelb") || s==="2" || s==="sk2") return "gelb";
      if(s.includes("grün") || s.includes("gruen") || s==="3" || s==="sk3") return "gruen";
      if(s.includes("schwarz") || s==="4" || s==="sk4") return "schwarz";
      return "rot";
    }

    function badgeTextFromSk(sk){
      if(sk==="rot") return "SK1 ROT";
      if(sk==="gelb") return "SK2 GELB";
      if(sk==="gruen") return "SK3 GRÜN";
      return "SCHWARZ";
    }

    function safeText(v){
      if(v === null || v === undefined) return "";
      return String(v);
    }

    function loadSelected(){
      try{
        const raw = localStorage.getItem(LS_SELECTED_KEY);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) selected = new Set(arr.map(String));
      }catch(e){}
    }

    function saveSelected(){
      try{
        localStorage.setItem(LS_SELECTED_KEY, JSON.stringify(Array.from(selected)));
      }catch(e){}
    }

    function loadTrainingState(){
      trainingEnabled = localStorage.getItem(LS_TRAINING_KEY) === "1";
      setToggle(trainingToggle, trainingEnabled);
    }

    function saveTrainingState(){
      localStorage.setItem(LS_TRAINING_KEY, trainingEnabled ? "1" : "0");
    }

    function updateCounts(){
      const map = { rot:0, gelb:0, gruen:0, schwarz:0 };
      for(const id of selected){
        const p = patients.find(x=>String(x.id)===String(id));
        if(!p) continue;
        map[p.sk] = (map[p.sk]||0) + 1;
      }
      const total = selected.size;

      elCntLoaded.textContent = "Geladen " + patients.length;
      elCntSelected.textContent = "Ausgewählt " + total;

      selTotalTxt.textContent = total + " ausgewählt";
      selRot.textContent = map.rot || 0;
      selGelb.textContent = map.gelb || 0;
      selGruen.textContent = map.gruen || 0;
      selSchwarz.textContent = map.schwarz || 0;
    }

    function applyToSelectStyle(sel){
      if(!sel) return;
      sel.classList.remove("to-rot","to-gelb","to-gruen","to-schwarz");
      const v = (sel.value||"").toLowerCase();
      if(v==="rot") sel.classList.add("to-rot");
      if(v==="gelb") sel.classList.add("to-gelb");
      if(v==="gruen" || v==="grün") sel.classList.add("to-gruen");
      if(v==="schwarz") sel.classList.add("to-schwarz");
    }

    function render(){
      elGrid.innerHTML = "";
      if(!patients.length){
        const d = document.createElement("div");
        d.className = "empty";
        d.id = "emptyState";
        d.textContent = "Keine Patienten gefunden. Prüfe Patienten.json";
        elGrid.appendChild(d);
        updateCounts();
        return;
      }

      patients.forEach(p=>{
        const wrap = document.createElement("div");
        wrap.className = "pat sk-" + p.sk;
        wrap.dataset.id = p.id;

        const head = document.createElement("div");
        head.className = "patHead";

        const title = document.createElement("div");
        title.className = "patTitle";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = "Patient " + p.nr;
        title.appendChild(name);

        const badge = document.createElement("div");
        badge.className = "badge " + p.sk;
        badge.textContent = badgeTextFromSk(p.sk);

        head.appendChild(title);
        head.appendChild(badge);

        const body = document.createElement("div");
        body.className = "patBody";

        const kv = document.createElement("div");
        kv.className = "kv";

        function addKV(k, v){
          const kk = document.createElement("div");
          kk.className = "k";
          kk.textContent = k;
          const vv = document.createElement("div");
          vv.className = "v";
          vv.textContent = v;
          kv.appendChild(kk);
          kv.appendChild(vv);
        }

        addKV("Alter", safeText(p.alter));
        addKV("Geschlecht", safeText(p.geschlecht));
        addKV("Darstellung", safeText(p.darstellung));
        addKV("AF, Puls", safeText(p.af) + "/min, " + safeText(p.puls) + "/min");

        const vm = document.createElement("div");
        vm.style.marginTop = "6px";
        vm.style.fontWeight = "1000";
        vm.style.color = "rgba(229,231,235,.95)";
        vm.textContent = "Verletzungsmuster: " + safeText(p.verletzung);
        body.appendChild(kv);
        body.appendChild(vm);

        const foot = document.createElement("div");
        foot.className = "patFoot";

        const chkWrap = document.createElement("label");
        chkWrap.className = "ablageCheck";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = selected.has(String(p.id));
        const chkTxt = document.createElement("span");
        chkTxt.textContent = "Für Ablage";
        chkWrap.appendChild(chk);
        chkWrap.appendChild(chkTxt);

        chk.addEventListener("change", ()=>{
          if(chk.checked) selected.add(String(p.id));
          else selected.delete(String(p.id));
          saveSelected();
          updateCounts();
        });

        const preview = document.createElement("button");
        preview.className = "previewBtn";
        preview.type = "button";
        preview.textContent = "Vorschau";
        preview.addEventListener("click", ()=>{
          const url = p.previewUrl || ("patient" + p.nr + ".html");
          window.location.href = url;
        });

        foot.appendChild(chkWrap);
        foot.appendChild(preview);

        const opt = document.createElement("details");
        opt.className = "patOpt";
        const sum = document.createElement("summary");
        sum.textContent = "Optionen";
        opt.appendChild(sum);

        const optBody = document.createElement("div");
        optBody.className = "optBody";

        const warn = document.createElement("div");
        warn.className = "warn";
        warn.textContent = "Patienten Verschlechterung wird zentral über Szenario gesteuert. Hier ist nur die Anzeige pro Patient.";
        optBody.appendChild(warn);

        opt.appendChild(optBody);

        wrap.appendChild(head);
        wrap.appendChild(body);
        wrap.appendChild(foot);
        wrap.appendChild(opt);

        elGrid.appendChild(wrap);
      });

      updateCounts();
    }

    function pickRandom(n){
      if(!patients.length) return;
      const all = patients.map(p=>String(p.id));
      const pool = all.slice();
      for(let i=pool.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        const t = pool[i]; pool[i]=pool[j]; pool[j]=t;
      }
      selected = new Set(pool.slice(0, Math.min(n, pool.length)));
      saveSelected();
      render();
    }

    function parseMix(str){
      const parts = String(str||"").split(",").map(x=>parseInt(x.trim(),10)).filter(x=>Number.isFinite(x) && x>0);
      if(parts.length!==3) return null;
      return parts;
    }

    function pickMix(parts){
      if(!patients.length) return;
      const [g,y,r] = parts;
      const greens = patients.filter(p=>p.sk==="gruen").map(p=>String(p.id));
      const yellows = patients.filter(p=>p.sk==="gelb").map(p=>String(p.id));
      const reds = patients.filter(p=>p.sk==="rot").map(p=>String(p.id));

      function takeRandom(arr, n){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          const t=a[i]; a[i]=a[j]; a[j]=t;
        }
        return a.slice(0, Math.min(n,a.length));
      }

      const pick = [
        ...takeRandom(greens, g),
        ...takeRandom(yellows, y),
        ...takeRandom(reds, r)
      ];

      selected = new Set(pick);
      saveSelected();
      render();
    }

    async function loadPatients(){
      const urls = ['Patienten.json','patienten.json','patients.json','Patients.json','/Patienten.json','/patienten.json','/patients.json'];
      let lastErr = null;

      for(const url of urls){
        try{
          const res = await fetch(url, { cache:"no-store" });
          if(!res.ok) throw new Error("HTTP " + res.status);
          const raw = await res.json();

          const arr = Array.isArray(raw) ? raw : (raw.patienten || raw.patients || raw.Patienten || raw.Patients || raw.data || []);
          const mapped = arr.map(p=>{
            const id = p.id ?? p.nr ?? p.patientId ?? p.patient ?? ("p"+Math.random());
            const nr = p.nr ?? p.patient ?? p.patientNr ?? p.patientenNr ?? p.id ?? "";
            const sk = skClassFromValue(p.sk ?? p.sichtung ?? p.skklasse ?? p.sk_klasse ?? p.kategorie ?? "rot");
            return {
              id: String(id),
              nr: safeText(nr),
              sk,
              alter: safeText(p.alter ?? p.age ?? ""),
              geschlecht: safeText(p.geschlecht ?? p.sex ?? ""),
              darstellung: safeText(p.darstellung ?? p.position ?? "unbekannt"),
              af: safeText(p.af ?? p.resp ?? ""),
              puls: safeText(p.puls ?? p.hr ?? ""),
              verletzung: safeText(p.verletzungsmuster ?? p.verletzung ?? p.injury ?? ""),
              previewUrl: p.url ?? p.seite ?? p.page ?? null
            };
          });

          patients = mapped.filter(x=>x.id);
          return;
        }catch(e){
          lastErr = e;
        }
      }

      console.error("Patienten laden fehlgeschlagen", lastErr);
      patients = [];
    }

    function initAccordionsClosed(){
      accTraining.removeAttribute("open");
      accDeterioration.removeAttribute("open");
      accSelection.removeAttribute("open");
    }

    function wireToggles(){
      trainingToggle.addEventListener("click", (e)=>{
        e.preventDefault();
        trainingEnabled = !trainingEnabled;
        setToggle(trainingToggle, trainingEnabled);
        saveTrainingState();
      });

      detToggle.addEventListener("click", (e)=>{
        e.preventDefault();
        const on = detToggle.classList.contains("on");
        setToggle(detToggle, !on);
      });
    }

    function wireButtons(){
      btnBack.addEventListener("click", ()=>{ window.location.href = "instruktor.html"; });
      btnAblage.addEventListener("click", ()=>{ window.location.href = "ablage1.html"; });
      btnOpenScenario.addEventListener("click", ()=>{ window.location.href = "szenario.html"; });

      bulkSelectAll.addEventListener("click", ()=>{
        selected = new Set(patients.map(p=>String(p.id)));
        saveSelected();
        render();
      });

      bulkClear.addEventListener("click", ()=>{
        selected = new Set();
        saveSelected();
        render();
      });

      bulkCancel.addEventListener("click", ()=>{
        selected = new Set();
        saveSelected();
        render();
      });

      bulkToAblage.addEventListener("click", ()=>{
        saveSelected();
        window.location.href = "ablage1.html";
      });

      quickRow.querySelectorAll(".chipBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const n = parseInt(btn.getAttribute("data-q"), 10);
          pickRandom(n);
        });
      });

      mixBtn.addEventListener("click", ()=>{
        const parts = parseMix(mixSelect.value);
        if(!parts){
          alert("Mix Auswahl ungültig");
          return;
        }
        pickMix(parts);
      });

      btnNewSelect.addEventListener("click", ()=>{
        const any = selected.size || 20;
        pickRandom(any);
      });
    }

    window.addEventListener("DOMContentLoaded", async ()=>{
      initAccordionsClosed();

      loadSelected();
      loadTrainingState();
      setToggle(detToggle, false);

      wireToggles();
      wireButtons();

      await loadPatients();
      render();
    });
  </script>

  <script src="/metrics.js" defer></script>
</body>
</html>


