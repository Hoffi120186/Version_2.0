<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patienten â€“ Ãœbersicht</title>
<link rel="manifest" href="/manifest.json" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
  :root{
    --card-w: min(92vw, 560px);
    --card-h: clamp(160px, 38vh, 240px);
    --gap: 14px;
    --radius: 16px;
    --shadow: 0 12px 30px rgba(0,0,0,.25);
    --blur: 10px;

    --ink:#fff;
    --muted: rgba(255,255,255,.75);
    --line: rgba(255,255,255,.22);

    /* Accent Colors (bleiben!) */
    --blue:#3b82f6;
    --blue2:#2563eb;
    --danger:#e53935;

    --card-bg: rgba(255,255,255,.12);
    --glass: rgba(0,0,0,.28);
  }

  *{ box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#0b0f1a url("fotos/Patientenkarte.jpg") center/cover no-repeat;
    color:#fff;
    min-height:100dvh;
    padding: calc(env(safe-area-inset-top) + 10px) 12px calc(env(safe-area-inset-bottom) + 12px);
  }
  body::before{ content:""; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:-1; }

  header{
    display:flex; align-items:center; justify-content:space-between;
    max-width: 960px; margin: 0 auto 8px;
    gap: 8px;
  }
  .title{ font-weight:800; font-size: clamp(18px, 5vw, 28px); text-align:center; }

  .actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

  /* ===== Buttons / Links (App-Flow, aber Farben bleiben als Akzent) ===== */
  .back,
  .to-ablage{
    text-decoration:none;
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    white-space: nowrap;

    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.18);
    box-shadow:0 6px 14px rgba(0,0,0,.22);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);

    transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .back:hover,
  .to-ablage:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 26px rgba(0,0,0,.32);
    filter: brightness(1.04);
  }
  .back:active,
  .to-ablage:active{ transform: scale(.985); }

  /* Akzent statt VollflÃ¤che */
  .back{
    border-color: rgba(229,57,53,.65);
    background: rgba(229,57,53,.16);
  }
  .to-ablage{
    border-color: rgba(59,130,246,.65);
    background: rgba(59,130,246,.16);
  }

  .toolbar{
    max-width:960px; margin: 8px auto 10px;
    display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-start;
  }
  .pill{
    background: rgba(255,255,255,.12);
    border: 1px solid var(--line);
    border-radius: 999px; padding: 8px 12px;
    font-weight:700; box-shadow: 0 6px 14px rgba(0,0,0,.18);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .pill small{ opacity:.85; font-weight:700; }

  .trainbar{
    max-width:960px; margin: 8px auto 10px; padding:12px;
    border-radius:12px;
    border:1px solid rgba(59,130,246,.45);
    background: rgba(59,130,246,.14);
    box-shadow: 0 10px 26px rgba(0,0,0,.18) inset;
    display:flex; flex-direction:column; gap:10px; align-items:stretch; justify-content:center;
    text-align:center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .trainbar .row{
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
  }
  .trainbar .label{
    font-weight:900; opacity:.95;
    background: rgba(0,0,0,.22);
    border: 1px solid rgba(255,255,255,.18);
    padding: 7px 10px;
    border-radius: 999px;
  }

  /* ===== Base Button ===== */
  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.22);
    background: rgba(255,255,255,.10);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    font-weight:800;
    cursor:pointer;

    box-shadow:0 6px 14px rgba(0,0,0,.22);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);

    transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 26px rgba(0,0,0,.32);
    filter: brightness(1.04);
  }
  .btn:active{ transform: scale(.985); }

  /* Primary: Blau bleibt, aber als Akzent/Glow (nicht VollflÃ¤che) */
  .btn.primary{
    background: linear-gradient(180deg, rgba(59,130,246,.26), rgba(37,99,235,.22));
    border-color: rgba(59,130,246,.65);
  }
  .btn.primary:hover{
    box-shadow:
      0 10px 26px rgba(59,130,246,.22),
      0 10px 26px rgba(0,0,0,.32);
  }

  .btn.active{ outline:2px solid rgba(59,130,246,.55); }

  .btn.mini{ padding:8px 10px; border-radius:999px; font-size:13px; font-weight:900; }
  .btn.preset{ min-width:54px; }

  select{
    border:1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.28);
    color:#fff;
    border-radius: 12px;
    padding: 9px 12px;
    font-weight:800;
    cursor:pointer;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .viewport{
    max-width: 960px;
    height: calc(100dvh - 280px);
    margin: 0 auto;
    overflow-y: auto;
    overscroll-behavior: contain;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
    perspective: 1000px;
  }

  .spacer{ height: 12vh; }

  .card{
    position: relative;
    width: var(--card-w);
    min-height: var(--card-h);
    margin: var(--gap) auto;
    padding: 14px 16px 86px;
    border-radius: var(--radius);
    background: var(--card-bg);
    border: 1px solid var(--line);
    box-shadow: var(--shadow);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    scroll-snap-align: center;
    cursor:pointer;
  }
  .card:hover{ outline:2px solid rgba(255,255,255,.12) }

  .card.rot     { border-left: 10px solid #e53935; }
  .card.gelb    { border-left: 10px solid #f3fc02; }
  .card.gruen   { border-left: 10px solid #2e7d32; }
  .card.schwarz { border-left: 10px solid #111; }

  .card h2{ margin: 0 0 6px; font-size: clamp(18px, 4.6vw, 22px); font-weight: 800; }
  .meta{ display:flex; flex-wrap:wrap; gap: 8px 14px; font-size: clamp(14px, 3.6vw, 16px); }
  .meta b{ opacity:.9; }

  .sichtung{
    display:inline-block; margin-top:8px; padding: 5px 10px; border-radius: 999px;
    font-weight: 800; font-size: clamp(12px, 3.2vw, 14px);
    box-shadow: 0 6px 14px rgba(0,0,0,.24);
  }
  .card.rot  .sichtung{ background:#e53935; color:#fff; }
  .card.gelb .sichtung{ background:#f3fc02; color:#111; }
  .card.gruen .sichtung{ background:#2e7d32; color:#fff; }
  .card.schwarz .sichtung{ background:#111; color:#fff; }

  /* Vorschau Button: dezent */
  .open{
    background: rgba(255,255,255,.10);
    color:#fff;
    border:1px solid rgba(255,255,255,.20);
    padding:6px 10px;
    border-radius:10px;
    font-weight:800;
    cursor:pointer;
    margin-top:10px;
    box-shadow:0 6px 14px rgba(0,0,0,.18);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  .open:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 22px rgba(0,0,0,.28);
    filter: brightness(1.04);
  }
  .open:active{ transform: scale(.985); }

  .train-controls{
    position:absolute; left:14px; right:14px; bottom:12px;
    display:none; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    padding:8px 10px; border-radius:10px;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .train-controls.show{ display:flex; }
  .group{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

  .check{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; font-weight:800; }
  .check input{ width:18px; height:18px; accent-color:#3b82f6; }

  /* Segment Buttons: Farben bleiben, aber weniger VollflÃ¤che */
  .seg{ display:flex; gap:6px; }
  .seg button{
    border:1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.35);
    color:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease, border-color .2s ease;
  }
  .seg button:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 18px rgba(0,0,0,.28);
    filter: brightness(1.05);
  }

  /* Akzentfarben (nicht komplett knallig) */
  .seg button[data-sk="rot"]{ background: rgba(229,57,53,.16); border-color: rgba(229,57,53,.70); }
  .seg button[data-sk="gelb"]{ background: rgba(243,252,2,.16); border-color: rgba(243,252,2,.70); color:#111; }
  .seg button[data-sk="gruen"]{ background: rgba(46,125,50,.16); border-color: rgba(46,125,50,.70); }
  .seg button[data-sk="schwarz"]{ background: rgba(17,17,17,.24); border-color: rgba(255,255,255,.25); }

  .seg button.active{
    outline:2px solid rgba(255,255,255,.65);
    box-shadow: 0 10px 22px rgba(0,0,0,.25);
  }

  /* Flags: Farben bleiben, dezenter */
  .flags { display:flex; gap:6px; align-items:center; }
  .flags button{
    border:1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.35);
    color:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease, border-color .2s ease;
  }
  .flags button:hover{
    transform: translateY(-1px);
    box-shadow:0 10px 18px rgba(0,0,0,.28);
    filter: brightness(1.05);
  }
  .flags button.active{ outline:2px solid rgba(255,255,255,.65); }
  .flags .t { background: rgba(229,57,53,.16); border-color: rgba(229,57,53,.70); }
  .flags .b { background: rgba(46,125,50,.16); border-color: rgba(46,125,50,.70); }

  .savebar{
    position: fixed; left:50%; transform:translateX(-50%);
    bottom: calc(env(safe-area-inset-bottom) + 8px);
    z-index: 50;
    display:none; gap:10px; align-items:center;
    background: rgba(0,0,0,.7);
    border:1px solid var(--line);
    padding:10px 12px; border-radius:14px;
    box-shadow: 0 10px 26px rgba(0,0,0,.35);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .savebar.show{ display:flex; }
  .savebar .info{ color:var(--muted); font-weight:700; }

  .toast{
    position: fixed; left:50%; transform: translateX(-50%);
    bottom: calc(70px + env(safe-area-inset-bottom));
    background: rgba(22,163,74,.95);
    color:#fff; font-weight:800; padding:10px 14px; border-radius: 12px;
    border:1px solid rgba(255,255,255,.25);
    box-shadow: 0 10px 26px rgba(0,0,0,.35);
    display:none; z-index:60;
  }
  .toast.show{ display:block; }

  .bulk-actions{ margin-left:auto; display:none; gap:8px; align-items:center; flex-wrap:wrap; }
  .bulk-actions.show{ display:flex; }

  @media (max-width: 520px){
    header{ align-items: flex-start; }
    .title{ order: 3; width: 100%; }
  }
</style>

<script src="/freigabe.js?v=2025-09-11-REV2" defer></script>
</head>

<body>
<header>
  <div class="actions">
    <a class="back" href="Instruktor.html">ZurÃ¼ck</a>
    <a id="toAblage" class="to-ablage" href="/ablage1.html" aria-label="Direkt zur Patientenablage">
      Direkt zur Pat. Ablage
    </a>
  </div>
  <div class="title">Patienten-Ãœbersicht</div>
</header>

<style>
  header { position: relative; z-index: 60; }
  .savebar { z-index: 50; }
</style>

<div class="toolbar">
  <span class="pill">Patienten geladen: <span id="count">0</span></span>
  <span class="pill" id="selPill" style="display:none">AusgewÃ¤hlt: <b id="selCount">0</b></span>

  <span class="pill" id="mixPill" style="display:none">
    <small>Auswahl:</small>
    ðŸ”´ <b id="mixRot">0</b> &nbsp;ðŸŸ¡ <b id="mixGelb">0</b> &nbsp;ðŸŸ¢ <b id="mixGruen">0</b> &nbsp;âš« <b id="mixSchwarz">0</b>
  </span>

  <div class="bulk-actions" id="bulk">
    <button id="bulkSelectAll" class="btn">Alle auswÃ¤hlen</button>
    <button id="bulkClear" class="btn">Auswahl lÃ¶schen</button>
  </div>
</div>

<div class="trainbar">
  <div class="row">
    <button id="trainingBtn" class="btn primary" type="button" aria-pressed="false">Training Patientenablage aktivieren</button>
  </div>

  <div class="row" id="presetRow" style="display:none">
    <span class="label">Schnellauswahl</span>

    <button class="btn mini preset" data-count="10" type="button">10</button>
    <button class="btn mini preset" data-count="15" type="button">15</button>
    <button class="btn mini preset" data-count="20" type="button">20</button>
    <button class="btn mini preset" data-count="25" type="button">25</button>
    <button class="btn mini preset" data-count="30" type="button">30</button>
    <button class="btn mini preset" data-count="35" type="button">35</button>
    <button class="btn mini preset" data-count="40" type="button">40</button>

    <select id="mixMode" aria-label="Auswahlmodus">
      <option value="mix" selected>Mix (20/30/50)</option>
      <option value="only-rot">Nur ROT</option>
      <option value="only-gelb">Nur GELB</option>
      <option value="only-gruen">Nur GRÃœN</option>
      <option value="only-schwarz">Nur SCHWARZ</option>
      <option value="manual">Manuell (nur selbst auswÃ¤hlen)</option>
    </select>

    <button id="reselectBtn" class="btn mini" type="button" title="Neue Auswahl (gleiche Anzahl)">
      Neu auswÃ¤hlen
    </button>
  </div>
</div>

<div class="viewport" id="viewport">
  <div class="spacer" aria-hidden="true"></div>
  <div id="list" aria-live="polite"></div>
  <div class="spacer" aria-hidden="true"></div>
</div>

<div id="savebar" class="savebar" role="region" aria-live="polite">
  <span class="info"><span id="selCountBottom">0</span> ausgewÃ¤hlt</span>
  <button id="saveBtn" class="btn primary" type="button">In Ablage Ã¼bernehmen</button>
  <button id="cancelBtn" class="btn" type="button">Abbrechen</button>
</div>

<div class="toast" id="toast">In Ablage Ã¼bernommen</div>

<script>
"use strict";

/* ===== Storage Helpers ===== */
function jget(k,f){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch(_){ return f; } }
function jset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }

/* Keys */
const LS_ACTIVE  = 'ablage.active.v1';
const LS_SESSION = 'ablage.sessionStart.v1';
const AUTOSTART  = 'ablage.autostart.ok';

/* ======= AUTO-START-SPERRE ======= */
function blockAutoStart() {
  const ok = localStorage.getItem(AUTOSTART) === 'true';
  if (ok) return;

  let active = jget(LS_ACTIVE, []);
  if (!Array.isArray(active) || !active.length) return;

  let changed = false;
  const now = Date.now();

  active = active.map(item => {
    if (!item || typeof item !== 'object') return item;
    if (typeof item.queuedAt !== 'number') { item.queuedAt = now; changed = true; }
    if (typeof item.offset !== 'number')   { item.offset = 0;   changed = true; }
    if ('addedAt' in item) { delete item.addedAt; changed = true; }
    if (item.startAt && (now - item.startAt) < 30000) { item.startAt = null; changed = true; }
    return item;
  });

  if (changed) jset(LS_ACTIVE, active);
}
function denyAutostart(){ localStorage.setItem(AUTOSTART, 'false'); blockAutoStart(); }
window.addEventListener('pageshow', denyAutostart);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState !== 'hidden') denyAutostart(); });
window.addEventListener('beforeunload', denyAutostart);

denyAutostart();
const t0_guard = Date.now();
const guardInterval = setInterval(()=>{
  denyAutostart();
  if (Date.now() - t0_guard > 8000) clearInterval(guardInterval);
}, 150);

/* ===== Patienten laden ===== */
async function loadPatients() {
  const urls = ["patienten.json", "patients.json"];
  let lastErr;
  for (const url of urls){
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const raw = await res.json();
      return raw.map(p=>{
        const kat = String(p.kategorie||p.Kategorie||"").toLowerCase().replace("grÃ¼n","gruen");
        const base = ({rot:{af:28,puls:120},gelb:{af:22,puls:100},gruen:{af:16,puls:80},schwarz:{af:0,puls:0}})[kat] || {af:18,puls:85};
        const gender = (p.gender??p.Gender??p.geschlecht??p.Geschlecht) ?? "â€”";
        const age = (p.age??p.Age??p.alter??p.Alter) ?? "â€”";
        const photo = p.photo || p.Photo || p.foto || p.Foto || null;
        return {
          id: Number(p.id ?? p.ID),
          kategorie: ["rot","gelb","gruen","schwarz"].includes(kat) ? kat : "gelb",
          darstellung: p.darstellung || p.Darstellung || "sitzend",
          verletzung: p.verletzung || p.Verletzung || "â€”",
          af: p.af ?? p.AF ?? base.af,
          puls: p.puls ?? p.Puls ?? base.puls,
          age, gender, photo
        };
      });
    }catch(e){ lastErr=e; }
  }
  throw new Error("Konnte patienten.json nicht laden: "+(lastErr?.message||"Unbekannt"));
}

/* ===== Sichtungs-/Flag-Storage ===== */
function getSMap(){ return jget('sichtungMap', {}); }
function setSMap(map){ jset('sichtungMap', map); }
function getFlagsFor(pid){ return jget('sicht_'+pid, {t:false,b:false}); }
function setFlagsFor(pid, flags){ jset('sicht_'+pid, { t: !!flags.t, b: !!flags.b }); }
function normalizeFlagsForCat(cat, flags){
  const f = { t: !!flags.t, b: !!flags.b };
  if (cat !== 'rot')   f.t = false;
  if (cat !== 'gruen') f.b = false;
  return f;
}

/* ===== State + DOM Refs ===== */
const listEl = document.getElementById("list");
const countEl = document.getElementById("count");
const toastEl = document.getElementById("toast");

const trainingBtn = document.getElementById("trainingBtn");
const savebar = document.getElementById("savebar");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const selPill = document.getElementById("selPill");
const selCountTop = document.getElementById("selCount");
const selCountBottom = document.getElementById("selCountBottom");

const bulkBox = document.getElementById('bulk');
const bulkSelectAllBtn = document.getElementById('bulkSelectAll');
const bulkClearBtn = document.getElementById('bulkClear');

const presetRow = document.getElementById('presetRow');
const mixPill = document.getElementById('mixPill');
const mixRot = document.getElementById('mixRot');
const mixGelb = document.getElementById('mixGelb');
const mixGruen = document.getElementById('mixGruen');
const mixSchwarz = document.getElementById('mixSchwarz');

const mixModeSel = document.getElementById('mixMode');
const reselectBtn = document.getElementById('reselectBtn');

let allPatients = [];
let training = false;
let lastPresetCount = 0;
let selected = new Map(); // id -> { sk:null|..., t:false, b:false }

/* ===== Render ===== */
function cardHTML(p){
  const katClass = p.kategorie === "gruen" ? "gruen" : p.kategorie;
  const katLabel = (p.kategorie === "gruen" ? "GRÃœN" : p.kategorie.toUpperCase());
  return `
    <article class="card ${katClass}" data-id="${p.id}">
      <h2>Patient ${p.id}</h2>
      <div class="meta"><b>Alter:</b> ${p.age}</div>
      <div class="meta"><b>Geschlecht:</b> ${p.gender}</div>
      <div class="meta"><b>Darstellung:</b> ${p.darstellung||"â€”"}</div>
      <div class="meta"><b>Verletzungsmuster:</b> ${p.verletzung||"â€”"}</div>
      <div class="meta"><b>AF:</b> ${p.af}/min&nbsp;&nbsp;&nbsp;<b>Puls:</b> ${p.puls}/min</div>
      <span class="sichtung">${katLabel}</span><br/>
      <button class="open" type="button">Vorschau</button>

      <div class="train-controls" aria-hidden="true" hidden inert>
        <div class="group check">
          <input type="checkbox" class="pick" id="pick-${p.id}" />
          <label for="pick-${p.id}">FÃ¼r Ablage</label>
        </div>

        <div class="group seg" aria-label="Sichtungsklasse wÃ¤hlen">
          <button type="button" data-sk="rot" title="SK1 ROT">ROT</button>
          <button type="button" data-sk="gelb" title="SK2 GELB">GELB</button>
          <button type="button" data-sk="gruen" title="SK3 GRÃœN">GRÃœN</button>
          <button type="button" data-sk="schwarz" title="SCHWARZ">SCHWARZ</button>
        </div>

        <div class="group flags" aria-label="Zusatz-Flags">
          <button type="button" data-flag="t" class="t" title="TransportprioritÃ¤t (nur SK1)">T</button>
          <button type="button" data-flag="b" class="b" title="Betroffener (nur SK3)">B</button>
        </div>
      </div>
    </article>
  `;
}

function renderList(){
  listEl.innerHTML = allPatients.map(cardHTML).join("");
  attachCardEvents();
  syncTrainingUI();
}

function attachCardEvents(){
  document.querySelectorAll(".card").forEach(card=>{
    const id = Number(card.dataset.id);
    const p = allPatients.find(x=>x.id===id);

    card.querySelector(".open").addEventListener("click", e=>{
      e.stopPropagation();
      try{ sessionStorage.setItem("currentPatient", JSON.stringify(p)); }catch(_){ }
      location.href = `patient${id}.html`;
    });

    const cb = card.querySelector(".pick");
    cb.addEventListener("change", ()=>{
      if(cb.checked){
        if(!selected.has(id)) selected.set(id, { sk: null, t:false, b:false });
      }else{
        selected.delete(id);
        card.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        card.querySelectorAll('.flags button').forEach(b=>b.classList.remove('active'));
      }
      updateCountersAndSavebar();
    });

    card.querySelectorAll('.seg button').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!cb.checked){ cb.checked = true; }
        if(!selected.has(id)) selected.set(id, { sk: null, t:false, b:false });

        const entry = selected.get(id);
        const sk = btn.getAttribute('data-sk');

        card.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');

        entry.sk = sk;
        const norm = normalizeFlagsForCat(sk, entry);
        entry.t = norm.t; entry.b = norm.b;

        const fT = card.querySelector('.flags [data-flag="t"]');
        const fB = card.querySelector('.flags [data-flag="b"]');
        fT.toggleAttribute('disabled', entry.sk !== 'rot');
        fB.toggleAttribute('disabled', entry.sk !== 'gruen');
        fT.classList.toggle('active', !!entry.t);
        fB.classList.toggle('active', !!entry.b);

        selected.set(id, entry);
        updateCountersAndSavebar();
      });
    });

    card.querySelectorAll('.flags [data-flag]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!cb.checked){ cb.checked = true; }
        if(!selected.has(id)) selected.set(id, { sk: null, t:false, b:false });
        const entry = selected.get(id);

        const flag = b.getAttribute('data-flag');
        if (flag==='t' && entry.sk!=='rot') return;
        if (flag==='b' && entry.sk!=='gruen') return;

        entry[flag] = !entry[flag];
        b.classList.toggle('active', !!entry[flag]);

        selected.set(id, entry);
        updateCountersAndSavebar();
      });
    });

    card.addEventListener("click", ()=>{ if(!training) location.href = `patient${id}.html`; });
  });
}

/* ===== Training UI ===== */
trainingBtn.addEventListener("click", ()=>{
  training = !training;
  trainingBtn.classList.toggle("active", training);
  trainingBtn.setAttribute("aria-pressed", String(training));
  trainingBtn.textContent = training ? "Training Patientenablage lÃ¤uft" : "Training Patientenablage aktivieren";

  if(!training){
    clearSelectionUI();
  }
  syncTrainingUI();
});

function syncTrainingUI(){
  document.querySelectorAll(".card .train-controls").forEach(el=>{
    const visible = training;
    el.classList.toggle("show", visible);
    el.toggleAttribute("hidden", !visible);
    el.setAttribute("aria-hidden", String(!visible));
    el.inert = !visible;
  });

  selPill.style.display = training ? "" : "none";
  presetRow.style.display = training ? "" : "none";
  mixPill.style.display = training ? "" : "none";
  bulkBox.classList.toggle('show', training);

  updateCountersAndSavebar();
}

/* ===== Auswahl-Helpers ===== */
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function computeTargets(total, weights){
  const cats = Object.keys(weights);
  const raw = cats.map(c => ({ c, v: total * weights[c] }));
  const base = {};
  raw.forEach(x => base[x.c] = Math.floor(x.v));

  let used = Object.values(base).reduce((s,n)=>s+n,0);
  let rest = total - used;

  raw
    .map(x => ({ c:x.c, frac: x.v - Math.floor(x.v) }))
    .sort((a,b)=>b.frac - a.frac)
    .forEach(x => { if(rest>0){ base[x.c]++; rest--; } });

  return base;
}

function clearSelectionUI(){
  selected.clear();
  document.querySelectorAll(".card .pick").forEach(cb=>cb.checked=false);
  document.querySelectorAll(".card .seg button").forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(".card .flags button").forEach(b=>b.classList.remove('active'));
}

function selectIds(ids){
  ids.forEach(id=>{
    const card = document.querySelector(`.card[data-id="${id}"]`);
    if(!card) return;
    const cb = card.querySelector(".pick");
    if(!cb.checked) cb.checked = true;
    if(!selected.has(id)) selected.set(id, { sk: null, t:false, b:false });
    card.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
    card.querySelectorAll('.flags button').forEach(b=>b.classList.remove('active'));
  });
}

function pickOnly(cat, total){
  const pool = shuffle(allPatients.filter(p=>p.kategorie===cat));
  return pool.slice(0, total).map(p=>p.id);
}

function pickMix(total){
  const targets = computeTargets(total, { rot:0.2, gelb:0.3, gruen:0.5, schwarz:0.0 });

  const pools = {
    rot: shuffle(allPatients.filter(p=>p.kategorie==="rot")),
    gelb: shuffle(allPatients.filter(p=>p.kategorie==="gelb")),
    gruen: shuffle(allPatients.filter(p=>p.kategorie==="gruen")),
    schwarz: shuffle(allPatients.filter(p=>p.kategorie==="schwarz")),
  };

  const chosen = [];
  const chosenIds = new Set();

  (["rot","gelb","gruen","schwarz"]).forEach(cat=>{
    const need = Math.max(0, targets[cat] || 0);
    const pool = pools[cat].filter(p=>!chosenIds.has(p.id));
    pool.slice(0, need).forEach(p=>{ chosen.push(p); chosenIds.add(p.id); });
  });

  let missing = total - chosen.length;
  if (missing > 0){
    const allRest = shuffle(allPatients).filter(p=>!chosenIds.has(p.id));
    allRest.slice(0, missing).forEach(p=>{ chosen.push(p); chosenIds.add(p.id); });
  }

  return chosen.slice(0,total).map(p=>p.id);
}

function applyPreset(count){
  if(!training) trainingBtn.click();

  const mode = mixModeSel.value || "mix";
  lastPresetCount = count;

  if (mode === "manual"){
    toast("Manuell aktiv â€“ bitte selbst auswÃ¤hlen");
    return;
  }

  bulkClearBtn.click();

  let ids = [];
  if (mode === "mix") ids = pickMix(count);
  else if (mode === "only-rot") ids = pickOnly("rot", count);
  else if (mode === "only-gelb") ids = pickOnly("gelb", count);
  else if (mode === "only-gruen") ids = pickOnly("gruen", count);
  else if (mode === "only-schwarz") ids = pickOnly("schwarz", count);
  else ids = pickMix(count);

  selectIds(ids);

  const wanted = count, got = ids.length;
  const label = mixModeSel.selectedOptions?.[0]?.textContent || "Preset";

  if (mode.startsWith("only-") && got < wanted){
    toast(`${label}: ${got}/${wanted} verfÃ¼gbar (Rest leer)`);
  } else {
    toast(`${label}: ${got} vorbereitet`);
  }

  updateCountersAndSavebar();
}

/* ===== Counter / Mix Anzeige ===== */
function updateCountersAndSavebar(){
  const n = selected.size;
  selCountTop.textContent = String(n);
  selCountBottom.textContent = String(n);
  savebar.classList.toggle("show", training && n>0);

  let r=0,g=0,gr=0,s=0;
  for(const [id, entry] of selected.entries()){
    let sk = entry?.sk;
    if(!sk){
      const p = allPatients.find(x=>x.id===id);
      sk = p?.kategorie || null;
    }
    if(sk==="rot") r++;
    else if(sk==="gelb") g++;
    else if(sk==="gruen") gr++;
    else if(sk==="schwarz") s++;
  }
  mixRot.textContent = String(r);
  mixGelb.textContent = String(g);
  mixGruen.textContent = String(gr);
  mixSchwarz.textContent = String(s);
}

/* ===== Bulk Actions ===== */
bulkSelectAllBtn.addEventListener('click', ()=>{
  document.querySelectorAll(".card").forEach(card=>{
    const id = Number(card.dataset.id);
    const cb = card.querySelector(".pick");
    if(!cb.checked) cb.checked = true;
    if(!selected.has(id)) selected.set(id, { sk: null, t:false, b:false });
  });
  updateCountersAndSavebar();
});

bulkClearBtn.addEventListener('click', ()=>{
  clearSelectionUI();
  updateCountersAndSavebar();
});

/* ===== Preset Buttons ===== */
document.querySelectorAll(".preset").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const count = Number(btn.getAttribute("data-count") || "0");
    applyPreset(count);
  });
});

reselectBtn.addEventListener("click", ()=>{
  const n = lastPresetCount || selected.size;
  if(!training || !n) return;
  applyPreset(n);
});

/* ===== Speichern â†’ Ablage (ohne Start) ===== */
saveBtn.addEventListener("click", ()=>{
  if(selected.size===0) return;

  denyAutostart();

  const now = Date.now();
  if(!jget(LS_SESSION, null)) jset(LS_SESSION, now);

  let active = jget(LS_ACTIVE, []);
  if(!Array.isArray(active)) active = [];
  const have = new Set(active.map(a=>a && a.id));
  let sMap = getSMap();

  for(const [id, entry] of selected.entries()){
    const p = allPatients.find(x=>x.id===id);
    if(!p) continue;
    const pid = `patient${p.id}`;

    const sk = entry?.sk || p.kategorie;
    const flags = normalizeFlagsForCat(sk, entry || {});

    sMap[pid] = sk;
    setFlagsFor(pid, flags);

    if(!have.has(pid)){
      active.push({
        id: pid,
        label: `Patient ${p.id}`,
        url: `patient${p.id}.html`,
        sk,
        queuedAt: now,
        startAt: null,
        offset: 0,
        from: "overview-training"
      });
      have.add(pid);
    }else{
      const i = active.findIndex(a=>a && a.id===pid);
      if(i>=0){
        active[i].sk = sk;
        if(typeof active[i].queuedAt !== 'number') active[i].queuedAt = now;
        active[i].startAt = null;
        if(typeof active[i].offset !== 'number') active[i].offset = 0;
        if('addedAt' in active[i]) delete active[i].addedAt;
      }
    }
  }

  setSMap(sMap);
  jset(LS_ACTIVE, active);

  const t0 = Date.now();
  const g = setInterval(()=>{
    denyAutostart();
    if (Date.now() - t0 > 5000) clearInterval(g);
  }, 150);

  toast("In Ablage Ã¼bernommen");
  clearSelectionUI();
  updateCountersAndSavebar();
});

cancelBtn.addEventListener("click", ()=>{
  clearSelectionUI();
  updateCountersAndSavebar();
});

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1600);
}

/* ===== Init ===== */
(async function init(){
  try{
    denyAutostart();
    allPatients = await loadPatients();
    countEl.textContent = String(allPatients.length);

    jset('patientsData', allPatients.map(p => ({
      id: p.id,
      age: p.age,
      gender: p.gender,
      photo: p.photo || null
    })));

    renderList();
  }catch(e){
    listEl.innerHTML =
      '<div style="background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);padding:16px;border-radius:12px">'
      + '<b>Fehler beim Laden:</b> '+e.message+'<br/>PrÃ¼fe Dateiname/Ort, JSON-Syntax und Cache.'
      + '</div>';
    console.error(e);
  }
})();
</script>

<script>
  window.METRICS_URL = "https://1rettungsmittel.de/metrics.php";
</script>
<script src="/metrics.js" defer></script>

</body>
</html>
